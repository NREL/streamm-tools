<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>topology &mdash; STREAMM-Tools 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="STREAMM-Tools 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
  
<a href="../index.html"><img src="../_static/logo.png" border="0" alt="sampledoc"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for topology</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Process topology information</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Dr. Travis Kemper</span>
<span class="c"># NREL</span>
<span class="c"># Initial Date 05/07/2013</span>
<span class="c"># travis.kemper@nrel.gov</span>

<span class="c"># Conversions</span>
<span class="n">KJ_KCAL</span> <span class="o">=</span> <span class="mf">0.23901</span>
<span class="n">GRO_SIG</span> <span class="o">=</span> <span class="mf">5.61230943</span>
<span class="n">NM_ANG</span> <span class="o">=</span> <span class="mf">10.0</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">bonds</span>         <span class="kn">import</span> <span class="n">Bond</span><span class="p">,</span>     <span class="n">BondContainer</span>
<span class="kn">from</span> <span class="nn">angles</span>        <span class="kn">import</span> <span class="n">Angle</span><span class="p">,</span>    <span class="n">AngleContainer</span>
<span class="kn">from</span> <span class="nn">dihedrals</span>     <span class="kn">import</span> <span class="n">Dihedral</span><span class="p">,</span> <span class="n">DihedralContainer</span>

<span class="kn">from</span> <span class="nn">parameters</span> <span class="kn">import</span> <span class="n">ParameterContainer</span>
<span class="c">#from particles import ParticleContainer</span>
<span class="kn">from</span> <span class="nn">structureContainer</span> <span class="kn">import</span> <span class="n">StructureContainer</span>
<span class="kn">from</span> <span class="nn">parameters</span> <span class="kn">import</span> <span class="n">imptype</span>

<span class="c">#from periodictable import periodictabled</span>

<span class="kn">import</span> <span class="nn">atomtypes</span><span class="o">,</span> <span class="nn">pbcs</span><span class="o">,</span> <span class="nn">xmol</span> 

<div class="viewcode-block" id="create_top"><a class="viewcode-back" href="../docstr_extras.html#topology.create_top">[docs]</a><span class="k">def</span> <span class="nf">create_top</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">ff_charges</span><span class="p">):</span> <span class="c"># Move out of class (or derived class)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find topology information for force-field input files</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="c"># New options that need to be passed</span>
    <span class="n">rerun_bonded</span> <span class="o">=</span> <span class="bp">False</span>  
    <span class="n">set_biaryl</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="n">set_ptma</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">limdih</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">limitdih_n</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>



    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; Read in </span><span class="si">%d</span><span class="s"> Bonds &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot; Read in </span><span class="si">%d</span><span class="s"> Angles &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">angleC</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot; Read in </span><span class="si">%d</span><span class="s"> Dihedrals &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="p">)</span>

    <span class="c"># Check bonds</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
        <span class="c"># Create nearest neighbor list</span>
        <span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="o">=</span> <span class="n">build_covnablist</span><span class="p">(</span><span class="n">strucC</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
            <span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">nblist_bonds</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; Found bonds </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Build nieghbor list with provided bonds </span>
        <span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="o">=</span> <span class="n">bonded_nblist</span><span class="p">(</span><span class="n">strucC</span><span class="p">)</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; Read in bonds </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">))</span>
    <span class="c"># Check angles</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">angleC</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>  <span class="ow">or</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
            <span class="n">strucC</span><span class="o">.</span><span class="n">angleC</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">nblist_angles</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; Found angles </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">angleC</span><span class="p">))</span>
    <span class="c"># Check dihedrals</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>  <span class="ow">or</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">rerun_bonded</span> <span class="p">):</span>
            <span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">nblist_dih</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; Found dihedrals </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="p">))</span>

    <span class="c"># Find rings</span>
    <span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span> <span class="o">=</span> <span class="n">find_rings</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pid_o</span><span class="p">,</span> <span class="n">ptclObj_o</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;create_top particles &quot;</span><span class="p">,</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">],</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">],</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
            <span class="c"># Write xyz file</span>
            <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;ring check&quot;</span>
            <span class="n">append</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">xmol_file</span> <span class="o">=</span> <span class="s">&quot;rings.xyz&quot;</span>
            <span class="n">xmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">,</span> <span class="n">xmol_file</span><span class="p">,</span><span class="n">comment</span><span class="p">,</span><span class="n">append</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;create_top 2 print particles in strucC.ptclC&quot;</span><span class="p">)</span>


    <span class="c"># Asign atom types</span>
    <span class="n">strucC</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">oplsaa</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">set_biaryl</span><span class="p">):</span>
        <span class="n">strucC</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">biaryl_types</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>
        <span class="n">strucC</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">interring_types</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">set_ptma</span><span class="p">):</span>
        <span class="n">strucC</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">set_pmmatypes</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>
        <span class="n">strucC</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">set_ptmatypes</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>

    <span class="c">#if( set_qgroup ):</span>
    <span class="n">strucC</span> <span class="o">=</span> <span class="n">set_chargegroups</span><span class="p">(</span> <span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">)</span>
    <span class="n">qgroup_maxvol</span><span class="p">(</span><span class="n">strucC</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pid_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">],</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">],</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span>

</div>
<div class="viewcode-block" id="set_param"><a class="viewcode-back" href="../docstr_extras.html#topology.set_param">[docs]</a><span class="k">def</span> <span class="nf">set_param</span><span class="p">(</span><span class="n">struc_o</span><span class="p">,</span><span class="n">param_all</span><span class="p">,</span><span class="n">norm_dihparam</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set force-field parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_file</span> <span class="o">=</span> <span class="s">&quot;param.log&quot;</span>
    <span class="n">param_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>

    <span class="n">ptclC_o</span> <span class="o">=</span>  <span class="n">struc_o</span><span class="o">.</span><span class="n">ptclC</span>
    <span class="n">bondC_o</span>  <span class="o">=</span> <span class="n">struc_o</span><span class="o">.</span><span class="n">bondC</span>
    <span class="n">angleC_o</span>  <span class="o">=</span> <span class="n">struc_o</span><span class="o">.</span><span class="n">angleC</span>
    <span class="n">dihC_o</span>  <span class="o">=</span> <span class="n">struc_o</span><span class="o">.</span><span class="n">dihC</span>
    <span class="n">impC_o</span>  <span class="o">=</span> <span class="n">struc_o</span><span class="o">.</span><span class="n">impC</span>
    
    <span class="n">ljtypC_all</span> <span class="o">=</span>  <span class="n">param_all</span><span class="o">.</span><span class="n">ljtypC</span>
    <span class="n">btypC_all</span> <span class="o">=</span>  <span class="n">param_all</span><span class="o">.</span><span class="n">btypC</span>
    <span class="n">atypC_all</span> <span class="o">=</span>  <span class="n">param_all</span><span class="o">.</span><span class="n">atypC</span>
    <span class="n">dtypC_all</span> <span class="o">=</span>  <span class="n">param_all</span><span class="o">.</span><span class="n">dtypC</span>
    <span class="n">imptypC_all</span> <span class="o">=</span>  <span class="n">param_all</span><span class="o">.</span><span class="n">imptypC</span>
    
    <span class="c">#</span>
    <span class="c"># Create new parameter container to hold each unique type</span>
    <span class="c">#   which exsists in the structure container struc_i</span>
    <span class="c">#   this is necessary for parameter outputs to no have</span>
    <span class="c">#   redundent values </span>
    <span class="c">#</span>
    <span class="n">paramC_p</span> <span class="o">=</span> <span class="n">ParameterContainer</span><span class="p">()</span>
    
    <span class="n">ljtypC_p</span> <span class="o">=</span>  <span class="n">paramC_p</span><span class="o">.</span><span class="n">ljtypC</span>
    <span class="n">btypC_p</span> <span class="o">=</span>  <span class="n">paramC_p</span><span class="o">.</span><span class="n">btypC</span>
    <span class="n">atypC_p</span> <span class="o">=</span>  <span class="n">paramC_p</span><span class="o">.</span><span class="n">atypC</span>
    <span class="n">dtypC_p</span> <span class="o">=</span>  <span class="n">paramC_p</span><span class="o">.</span><span class="n">dtypC</span>
    <span class="n">imptypC_p</span> <span class="o">=</span>  <span class="n">paramC_p</span><span class="o">.</span><span class="n">imptypC</span>
    <span class="c">#</span>
    <span class="n">paramC_p</span><span class="o">.</span><span class="n">set_nbfunc</span><span class="p">(</span> <span class="n">param_all</span><span class="o">.</span><span class="n">get_nbfunc</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">paramC_p</span><span class="o">.</span><span class="n">set_combmixrule</span><span class="p">(</span> <span class="n">param_all</span><span class="o">.</span><span class="n">get_combmixrule</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">paramC_p</span><span class="o">.</span><span class="n">set_genpairs</span><span class="p">(</span> <span class="n">param_all</span><span class="o">.</span><span class="n">get_genpairs</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">paramC_p</span><span class="o">.</span><span class="n">set_fudgeLJ</span><span class="p">(</span> <span class="n">param_all</span><span class="o">.</span><span class="n">get_fudgeLJ</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">paramC_p</span><span class="o">.</span><span class="n">set_fudgeQQ</span><span class="p">(</span> <span class="n">param_all</span><span class="o">.</span><span class="n">get_fudgeQQ</span><span class="p">()</span> <span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># Count atom types</span>
    <span class="c">#</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pid_o</span><span class="p">,</span> <span class="n">ptclObj_o</span>  <span class="ow">in</span> <span class="n">ptclC_o</span><span class="p">:</span>    
        <span class="n">new_type</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">lj_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fftype_i</span> <span class="o">=</span> <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="c">#mass_i = ptclObj_o.mass</span>
        <span class="k">for</span> <span class="n">lj_p</span><span class="p">,</span> <span class="n">ljObj_p</span>  <span class="ow">in</span> <span class="n">ljtypC_p</span><span class="p">:</span>    
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">ljObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lj_p</span><span class="p">)</span>
                <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;lmptype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lj_p</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; maches previous &#39;</span><span class="p">,</span> <span class="n">lj_p</span><span class="p">,</span><span class="n">ljObj_p</span><span class="o">.</span><span class="n">ptype1</span>
                
        <span class="k">if</span><span class="p">(</span> <span class="n">new_type</span> <span class="p">):</span>
            <span class="c"># Find type in ljtypC_all</span>
            <span class="n">cnt_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lj_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;lmptype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lj_p</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">lj_all</span><span class="p">,</span> <span class="n">ljObj_all</span>  <span class="ow">in</span> <span class="n">ljtypC_all</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">ljObj_all</span><span class="o">.</span><span class="n">ptype1</span><span class="p">):</span>
                    <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">type_found</span> <span class="p">):</span>
                    <span class="c"># Set mass of particle type</span>
                    <span class="c">#   This is need for some force-field input files (LAMMPS)</span>
                    <span class="c">#mass_i = </span>
                    <span class="n">ljObj_all</span><span class="o">.</span><span class="n">setpid</span><span class="p">(</span> <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="p">)</span>
                    <span class="c">#ljObj_all.setmass( mass_i )</span>
                    
                    
                    <span class="n">ljtypC_p</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ljObj_all</span><span class="p">)</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
                    
                    
            <span class="k">if</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; No LJ parameters were found for atom type </span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">,</span><span class="n">fftype_i</span>
                <span class="c">#raise TypeErrorb</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; Multiple LJ parameters were found for atom type </span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">,</span><span class="n">fftype_i</span>
                <span class="c">#raise TypeError</span>
    <span class="c">#</span>
    <span class="c"># Count bonds types</span>
    <span class="c">#</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">b_o</span><span class="p">,</span> <span class="n">bondObj_o</span>  <span class="ow">in</span> <span class="n">bondC_o</span><span class="p">:</span>
        <span class="n">new_type</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">btyp_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pid_i</span> <span class="o">=</span> <span class="n">bondObj_o</span><span class="o">.</span><span class="n">pgid1</span>
        <span class="n">pid_j</span> <span class="o">=</span> <span class="n">bondObj_o</span><span class="o">.</span><span class="n">pgid2</span>
        <span class="n">fftype_i</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_i</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_j</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_j</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">r_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">bondObj_o</span><span class="o">.</span><span class="n">pgid1</span> <span class="p">]</span><span class="o">.</span><span class="n">position</span>  <span class="p">)</span>
        <span class="n">r_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">bondObj_o</span><span class="o">.</span><span class="n">pgid2</span> <span class="p">]</span><span class="o">.</span><span class="n">position</span>  <span class="p">)</span>
        <span class="n">bond_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pbcs</span><span class="o">.</span><span class="n">delta_r_c</span><span class="p">(</span><span class="n">r_i</span><span class="p">,</span><span class="n">r_j</span><span class="p">,</span><span class="n">struc_o</span><span class="o">.</span><span class="n">getLatVec</span><span class="p">()</span> <span class="p">))</span>
        
        <span class="k">for</span> <span class="n">btyp_p</span><span class="p">,</span> <span class="n">btypObj_p</span>  <span class="ow">in</span> <span class="n">btypC_p</span><span class="p">:</span>
            <span class="n">p_i</span> <span class="o">=</span> <span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">p_j</span> <span class="o">=</span> <span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype2</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_j</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">btyp_p</span><span class="p">)</span>
                <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting bond atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> wiht bond length </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with r_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">bond_len</span><span class="p">,</span><span class="n">btyp_p</span><span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_r0</span><span class="p">(),</span><span class="n">bond_len</span><span class="o">-</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_r0</span><span class="p">()</span> <span class="p">)</span>
                <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                <span class="k">break</span> 
            <span class="k">elif</span><span class="p">(</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_j</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_i</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">btyp_p</span><span class="p">)</span>
                <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting bond atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> wiht bond length </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with r_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">bond_len</span><span class="p">,</span><span class="n">btyp_p</span><span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_r0</span><span class="p">(),</span><span class="n">bond_len</span><span class="o">-</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_r0</span><span class="p">()</span> <span class="p">)</span>
                <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                <span class="k">break</span> 
                
        <span class="k">if</span><span class="p">(</span> <span class="n">new_type</span> <span class="p">):</span>
            <span class="c"># Find type in btypC_all</span>
            <span class="n">cnt_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">btyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">b_all</span><span class="p">,</span> <span class="n">btypObj_all</span>  <span class="ow">in</span> <span class="n">btypC_all</span><span class="p">:</span>
                <span class="n">all_i</span> <span class="o">=</span> <span class="n">btypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                <span class="n">all_j</span> <span class="o">=</span> <span class="n">btypObj_all</span><span class="o">.</span><span class="n">ptype2</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">all_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">all_j</span> <span class="p">):</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">all_i</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">all_j</span> <span class="p">):</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span>
                    
                <span class="k">if</span><span class="p">(</span> <span class="n">type_found</span> <span class="p">):</span>
                    <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">bondObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">btypObj_all</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                    <span class="n">btypC_p</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">btypObj_all</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s">  Bond parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>
                        
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
                    <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting bond atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> wiht bond length </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with r_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">bond_len</span><span class="p">,</span><span class="n">btyp_p</span><span class="p">,</span><span class="n">btypObj_all</span><span class="o">.</span><span class="n">get_r0</span><span class="p">(),</span><span class="n">bond_len</span><span class="o">-</span><span class="n">btypObj_all</span><span class="o">.</span><span class="n">get_r0</span><span class="p">()</span> <span class="p">)</span>
                    <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                    
            <span class="k">if</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; No Bond parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s">  Bond parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">btyp_p</span><span class="p">,</span> <span class="n">btypObj_p</span>  <span class="ow">in</span> <span class="n">btypC_p</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">btyp_p</span> <span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype2</span>                    
                <span class="k">raise</span> <span class="ne">TypeError</span>
                    

    <span class="c">#</span>
    <span class="c"># Count angles types</span>
    <span class="c">#</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">a_o</span><span class="p">,</span><span class="n">angleObj_o</span> <span class="ow">in</span> <span class="n">angleC_o</span><span class="p">:</span>
        <span class="n">new_type</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">atyp_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pid_k</span> <span class="o">=</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid1</span>
        <span class="n">pid_i</span> <span class="o">=</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid2</span>
        <span class="n">pid_j</span> <span class="o">=</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid3</span>
        <span class="n">fftype_k</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid1</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_i</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid2</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_j</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">angleObj_o</span><span class="o">.</span><span class="n">pgid3</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">r_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_k</span> <span class="p">]</span><span class="o">.</span><span class="n">position</span>  <span class="p">)</span>
        <span class="n">r_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_i</span> <span class="p">]</span><span class="o">.</span><span class="n">position</span>  <span class="p">)</span>
        <span class="n">r_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_j</span> <span class="p">]</span><span class="o">.</span><span class="n">position</span>  <span class="p">)</span>
        <span class="n">r_ik</span> <span class="o">=</span> <span class="n">pbcs</span><span class="o">.</span><span class="n">delta_r_c</span><span class="p">(</span><span class="n">r_i</span><span class="p">,</span><span class="n">r_k</span><span class="p">,</span><span class="n">struc_o</span><span class="o">.</span><span class="n">getLatVec</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">r_ij</span> <span class="o">=</span> <span class="n">pbcs</span><span class="o">.</span><span class="n">delta_r_c</span><span class="p">(</span><span class="n">r_i</span><span class="p">,</span><span class="n">r_j</span><span class="p">,</span><span class="n">struc_o</span><span class="o">.</span><span class="n">getLatVec</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">angle_kij</span> <span class="o">=</span> <span class="n">pbcs</span><span class="o">.</span><span class="n">getAngle</span><span class="p">(</span><span class="n">r_ik</span><span class="p">,</span><span class="n">r_ij</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atyp_p</span><span class="p">,</span> <span class="n">atypObj_p</span>  <span class="ow">in</span> <span class="n">atypC_p</span><span class="p">:</span>
            <span class="n">p_k</span> <span class="o">=</span> <span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">p_i</span> <span class="o">=</span> <span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype2</span> 
            <span class="n">p_j</span> <span class="o">=</span> <span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype3</span>
            <span class="n">theta0_kij</span> <span class="o">=</span> <span class="n">atypObj_p</span><span class="o">.</span><span class="n">get_theta0</span><span class="p">()</span>
            <span class="n">delta_theta</span> <span class="o">=</span> <span class="n">angle_kij</span> <span class="o">-</span> <span class="n">theta0_kij</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_j</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">atyp_p</span><span class="p">)</span>
                <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                
                <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting angle atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s">  wiht angle </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with theta_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_k</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">angle_kij</span><span class="p">,</span><span class="n">atyp_p</span><span class="p">,</span><span class="n">theta0_kij</span><span class="p">,</span><span class="n">delta_theta</span> <span class="p">)</span>
                <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                    
                <span class="k">break</span> 
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_j</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">atyp_p</span><span class="p">)</span>
                <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting angle atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s">  wiht angle </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with theta_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_k</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">angle_kij</span><span class="p">,</span><span class="n">atyp_p</span><span class="p">,</span><span class="n">theta0_kij</span><span class="p">,</span><span class="n">delta_theta</span> <span class="p">)</span>
                <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                <span class="k">break</span> 
                
        <span class="k">if</span><span class="p">(</span> <span class="n">new_type</span> <span class="p">):</span>
            <span class="c"># Find type in btypC_all</span>
            <span class="n">cnt_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">atyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a_all</span><span class="p">,</span> <span class="n">atypObj_all</span>  <span class="ow">in</span> <span class="n">atypC_all</span><span class="p">:</span>
                <span class="n">all_k</span> <span class="o">=</span> <span class="n">atypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                <span class="n">all_i</span> <span class="o">=</span> <span class="n">atypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                <span class="n">all_j</span> <span class="o">=</span> <span class="n">atypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                <span class="n">theta0_kij</span> <span class="o">=</span>  <span class="n">atypObj_all</span><span class="o">.</span><span class="n">get_theta0</span><span class="p">()</span>
                <span class="n">delta_theta</span> <span class="o">=</span> <span class="n">angle_kij</span><span class="o">-</span><span class="n">theta0_kij</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">all_k</span>  <span class="ow">and</span> <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">all_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">all_j</span> <span class="p">):</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">all_k</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">all_i</span>  <span class="ow">and</span>  <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">all_j</span> <span class="p">):</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 

                <span class="k">if</span><span class="p">(</span> <span class="n">type_found</span> <span class="p">):</span>
                    <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">angleObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">atypObj_all</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                    <span class="n">atypC_p</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">atypObj_all</span><span class="p">)</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Angles parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>
                    <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; Setting angle atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s">  wiht angle </span><span class="si">%f</span><span class="s"> to type </span><span class="si">%d</span><span class="s"> with theta_o </span><span class="si">%f</span><span class="s">  delta </span><span class="si">%f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_k</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">angle_kij</span><span class="p">,</span><span class="n">atyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">theta0_kij</span><span class="p">,</span><span class="n">delta_theta</span> <span class="p">)</span>
                    <span class="n">param_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                    
            <span class="k">if</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; No Angles parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="n">log_line</span><span class="o">=</span><span class="s">&quot; </span><span class="si">%d</span><span class="s"> Angles parameters were found for angle atoms </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> numbers </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s"> - </span><span class="si">%d</span><span class="s">  wiht angle </span><span class="si">%f</span><span class="s">  </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">pid_k</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">angle_kij</span> <span class="p">)</span>
                <span class="c">#param_out.write(log_line)</span>
                <span class="k">print</span> <span class="n">log_line</span>
                <span class="n">atypC_p</span><span class="o">.</span><span class="n">findtype</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">)</span>

                <span class="k">raise</span> <span class="ne">TypeError</span>
               
 
    <span class="c">#</span>
    <span class="c"># Count dihedrals types</span>
    <span class="c">#</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">dtypObj_all</span>  <span class="ow">in</span> <span class="n">dtypC_all</span><span class="p">:</span>
            <span class="n">all_k</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">all_i</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
            <span class="n">all_j</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
            <span class="n">all_l</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype4</span>
            <span class="k">print</span> <span class="s">&quot; all types in parameters &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span><span class="p">,</span><span class="n">dtypObj_all</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
            <span class="c">#sys.exit(&quot;  type check debug &quot;)</span>
            
    <span class="n">imp_cnt</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">d_o</span><span class="p">,</span><span class="n">dihObj_o</span> <span class="ow">in</span> <span class="n">dihC_o</span><span class="p">:</span>
        <span class="n">new_type</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">dtyp_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pid_i</span> <span class="o">=</span> <span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid2</span> 
        <span class="n">pid_j</span> <span class="o">=</span> <span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid3</span>
        <span class="n">fftype_k</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid1</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_i</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_i</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_j</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span><span class="n">pid_j</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_l</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid4</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; checking &quot;</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span> <span class="n">fftype_i</span><span class="p">,</span>  <span class="n">fftype_j</span> <span class="p">,</span> <span class="n">fftype_l</span>
        <span class="c"># Check to see if dihedral type is already in parameter set for the structure container</span>
        <span class="k">for</span> <span class="n">dtyp_p</span><span class="p">,</span> <span class="n">dtypObj_p</span>  <span class="ow">in</span> <span class="n">dtypC_p</span><span class="p">:</span>
            <span class="n">p_k</span> <span class="o">=</span> <span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">p_i</span> <span class="o">=</span> <span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype2</span> 
            <span class="n">p_j</span> <span class="o">=</span> <span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype3</span>
            <span class="n">p_l</span> <span class="o">=</span> <span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype4</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_j</span>  <span class="ow">and</span>  <span class="n">fftype_l</span> <span class="o">==</span> <span class="n">p_l</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">dtyp_p</span><span class="p">)</span>
                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; dihObj_o.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; dihObj_o.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot;  previous type &quot;</span><span class="p">,</span><span class="n">dtyp_p</span><span class="p">,</span><span class="n">p_k</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="n">p_j</span><span class="p">,</span><span class="n">p_l</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_l</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_j</span>  <span class="ow">and</span>  <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_l</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">dtyp_p</span><span class="p">)</span>
                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; dihObj_o.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; dihObj_o.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot;  previous type &quot;</span><span class="p">,</span><span class="n">dtyp_p</span><span class="p">,</span><span class="n">p_k</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="n">p_j</span><span class="p">,</span><span class="n">p_l</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="c"># If it is not in the parameter set for the struture container</span>
        <span class="c">#  find it in the parameters from the reference parameter file </span>
        <span class="k">if</span><span class="p">(</span> <span class="n">new_type</span> <span class="p">):</span>
            <span class="c"># Find type in btypC_all</span>
            <span class="n">cnt_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="c"># Set type to new type = last type+1</span>
            <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">dtyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;  new type checking against </span><span class="si">%d</span><span class="s"> read in parameters &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">dtypC_all</span><span class="p">)</span>

            <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">dtypObj_all</span>  <span class="ow">in</span> <span class="n">dtypC_all</span><span class="p">:</span>
                <span class="n">all_k</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                <span class="n">all_i</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                <span class="n">all_j</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                <span class="n">all_l</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>    
                <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span> <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                    <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dtypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dtypObj_all</span><span class="p">)</span>
                    <span class="c">#dtypObj_temp.set_g_indx(dtypObj_all.get_g_indx())</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s">&quot;     from  type to dtypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>
                    
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; checking  X - FF - FF - FF &quot;</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">dtypObj_all</span>  <span class="ow">in</span> <span class="n">dtypC_all</span><span class="p">:</span>
                    <span class="n">all_k</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                    <span class="n">all_i</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                    <span class="n">all_j</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                    <span class="n">all_l</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_l</span>  <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span> <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                        
                    <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                        <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dtypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dtypObj_all</span><span class="p">)</span>
                        <span class="c">#dtypObj_temp.set_g_indx(dtypObj_all.get_g_indx())</span>
                        <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                            <span class="k">print</span> <span class="s">&quot;     from  type to dtypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>
                            
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; checking  X - FF - FF - X &quot;</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">dtypObj_all</span>  <span class="ow">in</span> <span class="n">dtypC_all</span><span class="p">:</span>
                    <span class="n">all_k</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                    <span class="n">all_i</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                    <span class="n">all_j</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                    <span class="n">all_l</span> <span class="o">=</span> <span class="n">dtypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                        <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dtypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dtypObj_all</span><span class="p">)</span>
                        <span class="c">#dtypObj_temp.set_g_indx(dtypObj_all.get_g_indx())</span>
                        <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                            <span class="k">print</span> <span class="s">&quot;     from  type to dtypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; No Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> please check parameter file  &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">dtypObj_temp</span>
                <span class="c">#dtypObj_temp_list.findtype(fftype_k,fftype_i,fftype_j,fftype_l)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>

                    <span class="k">print</span> <span class="s">&quot; adding new type to dtypC_p  from &quot;</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype1</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype3</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype4</span>
                
                <span class="c"># Set FF types to read in bond to remove X&#39;s </span>
                <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype1</span> <span class="o">=</span> <span class="n">fftype_k</span>
                <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype2</span> <span class="o">=</span> <span class="n">fftype_i</span>
                <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype3</span> <span class="o">=</span> <span class="n">fftype_j</span>
                <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">ptype4</span> <span class="o">=</span> <span class="n">fftype_l</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">norm_dihparam</span> <span class="p">):</span>
                    <span class="c"># normalize by number of nieghbors</span>
                    <span class="n">dihen_norm</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; Normalizing dihedral potential &quot;</span>
                        <span class="k">print</span> <span class="s">&quot; finding types for &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span>
                    <span class="n">NNAB_i</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_j</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    
                    <span class="n">dihen_norm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">NNAB_i</span> <span class="o">+</span> <span class="n">NNAB_j</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; dihen_norm &quot;</span><span class="p">,</span><span class="n">dihen_norm</span>
                    <span class="k">print</span> <span class="s">&quot; dihen_norm &quot;</span><span class="p">,</span><span class="n">dihen_norm</span>

                    <span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">normforceconstants</span><span class="p">(</span><span class="n">dihen_norm</span><span class="p">)</span>


                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">dtyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">dihObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="n">dtypC_p</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">dtypObj_temp</span><span class="p">)</span>                
                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot; len(dtypC_p) &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dtypC_p</span><span class="p">)</span> 
                    <span class="k">print</span> <span class="s">&quot; dtypObj_temp.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; dtypObj_temp.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">dtypObj_temp</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 
    <span class="c">#</span>
    <span class="c"># Count improper dihedrals types</span>
    <span class="c">#</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">imptypObj_all</span>  <span class="ow">in</span> <span class="n">imptypC_all</span><span class="p">:</span>
            <span class="n">all_k</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">all_i</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
            <span class="n">all_j</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
            <span class="n">all_l</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype4</span>
            <span class="k">print</span> <span class="s">&quot; all types in parameters &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span><span class="p">,</span><span class="n">imptypObj_all</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
            <span class="c">#sys.exit(&quot;  type check debug &quot;)</span>
            
    <span class="n">imp_cnt</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">imp_o</span><span class="p">,</span><span class="n">impObj_o</span> <span class="ow">in</span> <span class="n">impC_o</span><span class="p">:</span>
        <span class="n">new_type</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">imptyp_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pid_k</span> <span class="o">=</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid1</span>
        <span class="n">pid_i</span> <span class="o">=</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid2</span> 
        <span class="n">pid_j</span> <span class="o">=</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid3</span>
        <span class="n">pid_l</span> <span class="o">=</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid4</span> 
        <span class="n">fftype_k</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid1</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_i</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">pid_i</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_j</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span><span class="n">pid_j</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
        <span class="n">fftype_l</span> <span class="o">=</span>  <span class="n">ptclC_o</span><span class="p">[</span> <span class="n">impObj_o</span><span class="o">.</span><span class="n">pgid4</span> <span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; checking &quot;</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span> <span class="n">fftype_i</span><span class="p">,</span>  <span class="n">fftype_j</span> <span class="p">,</span> <span class="n">fftype_l</span>
        <span class="c"># Check to see if impedral type is already in parameter set for the structure container</span>
        <span class="k">for</span> <span class="n">imptyp_p</span><span class="p">,</span> <span class="n">imptypObj_p</span>  <span class="ow">in</span> <span class="n">imptypC_p</span><span class="p">:</span>
            <span class="n">p_k</span> <span class="o">=</span> <span class="n">imptypObj_p</span><span class="o">.</span><span class="n">ptype1</span> 
            <span class="n">p_i</span> <span class="o">=</span> <span class="n">imptypObj_p</span><span class="o">.</span><span class="n">ptype2</span> 
            <span class="n">p_j</span> <span class="o">=</span> <span class="n">imptypObj_p</span><span class="o">.</span><span class="n">ptype3</span>
            <span class="n">p_l</span> <span class="o">=</span> <span class="n">imptypObj_p</span><span class="o">.</span><span class="n">ptype4</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_j</span>  <span class="ow">and</span>  <span class="n">fftype_l</span> <span class="o">==</span> <span class="n">p_l</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">imptyp_p</span><span class="p">)</span>
                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">imptypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; impObj_o.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; impObj_o.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot;  previous type &quot;</span><span class="p">,</span><span class="n">imptyp_p</span><span class="p">,</span><span class="n">p_k</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="n">p_j</span><span class="p">,</span><span class="n">p_l</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">fftype_l</span> <span class="o">==</span> <span class="n">p_k</span>  <span class="ow">and</span>  <span class="n">fftype_j</span> <span class="o">==</span> <span class="n">p_i</span>  <span class="ow">and</span>  <span class="n">fftype_i</span> <span class="o">==</span> <span class="n">p_j</span>  <span class="ow">and</span>  <span class="n">fftype_k</span> <span class="o">==</span> <span class="n">p_l</span> <span class="p">):</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">imptyp_p</span><span class="p">)</span>
                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">imptypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; impObj_o.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; impObj_o.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot;  previous type &quot;</span><span class="p">,</span><span class="n">imptyp_p</span><span class="p">,</span><span class="n">p_k</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="n">p_j</span><span class="p">,</span><span class="n">p_l</span><span class="p">,</span><span class="n">impObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="c"># If it is not in the parameter set for the struture container</span>
        <span class="c">#  find it in the parameters from the reference parameter file </span>
        <span class="k">if</span><span class="p">(</span> <span class="n">new_type</span> <span class="p">):</span>
            <span class="c"># Find type in btypC_all</span>
            <span class="n">cnt_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="c"># Set type to new type = last type+1</span>
            <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">imptyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;  new type checking against </span><span class="si">%d</span><span class="s"> read in parameters &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">imptypC_all</span><span class="p">)</span>

            <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">imptypObj_all</span>  <span class="ow">in</span> <span class="n">imptypC_all</span><span class="p">:</span>
                <span class="n">all_k</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                <span class="n">all_i</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                <span class="n">all_j</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                <span class="n">all_l</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>    
                <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span> <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                    <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">imptypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">imptypObj_all</span><span class="p">)</span>
                    <span class="c">#imptypObj_temp.set_g_indx(imptypObj_all.get_g_indx())</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Imp Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s">&quot;     from  type to imptypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>
                    
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; checking  X - FF - FF - FF &quot;</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">imptypObj_all</span>  <span class="ow">in</span> <span class="n">imptypC_all</span><span class="p">:</span>
                    <span class="n">all_k</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                    <span class="n">all_i</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                    <span class="n">all_j</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                    <span class="n">all_l</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_l</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="n">fftype_l</span>  <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="n">fftype_k</span> <span class="ow">and</span> <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                        
                    <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                        <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">imptypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">imptypObj_all</span><span class="p">)</span>
                        <span class="c">#imptypObj_temp.set_g_indx(imptypObj_all.get_g_indx())</span>
                        <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Imp Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                            <span class="k">print</span> <span class="s">&quot;     from  type to imptypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>
                            
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; checking  X - FF - FF - X &quot;</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                <span class="k">for</span> <span class="n">d_all</span><span class="p">,</span> <span class="n">imptypObj_all</span>  <span class="ow">in</span> <span class="n">imptypC_all</span><span class="p">:</span>
                    <span class="n">all_k</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype1</span> 
                    <span class="n">all_i</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype2</span> 
                    <span class="n">all_j</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype3</span>
                    <span class="n">all_l</span> <span class="o">=</span> <span class="n">imptypObj_all</span><span class="o">.</span><span class="n">ptype4</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_j</span> <span class="ow">and</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">all_l</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span> <span class="ow">and</span>  <span class="n">all_j</span> <span class="o">==</span> <span class="n">fftype_i</span> <span class="ow">and</span>   <span class="n">all_i</span> <span class="o">==</span> <span class="n">fftype_j</span>  <span class="ow">and</span> <span class="n">all_k</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span>   <span class="p">):</span>
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="k">if</span><span class="p">(</span> <span class="n">copy_type</span> <span class="p">):</span>
                        <span class="n">cnt_check</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">imptypObj_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">imptypObj_all</span><span class="p">)</span>
                        <span class="c">#imptypObj_temp.set_g_indx(imptypObj_all.get_g_indx())</span>
                        <span class="n">type_found</span> <span class="o">=</span> <span class="bp">True</span> 
                        <span class="n">copy_type</span> <span class="o">=</span> <span class="bp">False</span> 
                        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Imp Dih parameters were found for bond type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                            <span class="k">print</span> <span class="s">&quot;     from  type to imptypC_p  from &quot;</span><span class="p">,</span><span class="n">all_k</span><span class="p">,</span><span class="n">all_i</span><span class="p">,</span><span class="n">all_j</span><span class="p">,</span><span class="n">all_l</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; No Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">cnt_check</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> please check parameter file  &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">imptypObj_temp</span>
                <span class="c">#imptypObj_temp_list.findtype(fftype_k,fftype_i,fftype_j,fftype_l)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">type_found</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>

                    <span class="k">print</span> <span class="s">&quot; adding new type to imptypC_p  from &quot;</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype1</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype3</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype4</span>
                
                <span class="c"># Set FF types to read in bond to remove X&#39;s </span>
                <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype1</span> <span class="o">=</span> <span class="n">fftype_k</span>
                <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype2</span> <span class="o">=</span> <span class="n">fftype_i</span>
                <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype3</span> <span class="o">=</span> <span class="n">fftype_j</span>
                <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">ptype4</span> <span class="o">=</span> <span class="n">fftype_l</span>

                <span class="n">norm_impdihparam</span> <span class="o">=</span> <span class="bp">False</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">norm_impdihparam</span> <span class="p">):</span>
                    <span class="c"># normalize by number of nieghbors</span>
                    <span class="n">dihen_norm</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; Normalizing dihedral potential &quot;</span>
                        <span class="k">print</span> <span class="s">&quot; finding types for &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span>
                    <span class="n">NNAB_i</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_j</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    
                    <span class="n">dihen_norm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">NNAB_i</span> <span class="o">+</span> <span class="n">NNAB_j</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; dihen_norm &quot;</span><span class="p">,</span><span class="n">dihen_norm</span>
                    <span class="k">print</span> <span class="s">&quot; dihen_norm &quot;</span><span class="p">,</span><span class="n">dihen_norm</span>

                    <span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">normforceconstants</span><span class="p">(</span><span class="n">dihen_norm</span><span class="p">)</span>

                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_lmpindx</span><span class="p">(</span><span class="n">imptyp_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">impObj_o</span><span class="o">.</span><span class="n">set_g_indx</span><span class="p">(</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">())</span>
                <span class="n">imptypC_p</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">imptypObj_temp</span><span class="p">)</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> Dih parameters were found for dih type </span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cnt_check</span><span class="p">,</span><span class="n">fftype_k</span><span class="p">,</span><span class="n">fftype_i</span><span class="p">,</span><span class="n">fftype_j</span><span class="p">,</span><span class="n">fftype_l</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot; len(imptypC_p) &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">imptypC_p</span><span class="p">)</span> 
                    <span class="k">print</span> <span class="s">&quot; imptypObj_temp.get_lmpindx()  &quot;</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> 
                    <span class="k">print</span> <span class="s">&quot; imptypObj_temp.get_g_indx()  &quot;</span><span class="p">,</span><span class="n">imptypObj_temp</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; LJ atom types found </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ljtypC_p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">lj_p</span><span class="p">,</span> <span class="n">ljObj_p</span>  <span class="ow">in</span> <span class="n">ljtypC_p</span><span class="p">:</span> 
            <span class="k">print</span> <span class="n">lj_p</span><span class="p">,</span><span class="n">ljObj_p</span><span class="o">.</span><span class="n">ptype1</span><span class="p">,</span><span class="n">ljObj_p</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span><span class="n">ljObj_p</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span><span class="n">ljObj_p</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">print</span> <span class="s">&quot; Bond types found </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">btypC_p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">btyp_p</span><span class="p">,</span> <span class="n">btypObj_p</span>  <span class="ow">in</span> <span class="n">btypC_p</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">btyp_p</span> <span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">(),</span><span class="n">btypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot; Angle types found </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atypC_p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">atyp_p</span><span class="p">,</span> <span class="n">atypObj_p</span>  <span class="ow">in</span> <span class="n">atypC_p</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">atyp_p</span> <span class="p">,</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">,</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">ptype3</span><span class="p">,</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">(),</span><span class="n">atypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot; Dih types found </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dtypC_p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">dtyp_p</span><span class="p">,</span> <span class="n">dtypObj_p</span>  <span class="ow">in</span> <span class="n">dtypC_p</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">dtyp_p</span> <span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype3</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype4</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">(),</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot; imp Dih types found </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramC_p</span><span class="o">.</span><span class="n">imptypC</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">imptyp_p</span><span class="p">,</span> <span class="n">dtypObj_p</span>  <span class="ow">in</span> <span class="n">imptypC_p</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">imptyp_p</span> <span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype1</span> <span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype2</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype3</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">ptype4</span><span class="p">,</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">(),</span><span class="n">dtypObj_p</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;find_types&#39;</span><span class="p">)</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;  All particles should have new type labeled as interger stored as a string &quot;</span>
        <span class="k">for</span> <span class="n">pid_o</span><span class="p">,</span> <span class="n">ptclObj_o</span>  <span class="ow">in</span> <span class="n">ptclC_o</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">],</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">type</span>
        <span class="k">for</span> <span class="n">d_o</span><span class="p">,</span><span class="n">dihObj_o</span> <span class="ow">in</span> <span class="n">dihC_o</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot; lmpindx() g_indx()  &quot;</span><span class="p">,</span><span class="n">d_o</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid1</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid2</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid3</span><span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">pgid4</span><span class="p">,</span> <span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_lmpindx</span><span class="p">()</span> <span class="p">,</span><span class="n">dihObj_o</span><span class="o">.</span><span class="n">get_g_indx</span><span class="p">()</span> 

    <span class="n">param_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">paramC_p</span><span class="p">,</span><span class="n">struc_o</span>


</div>
<span class="k">def</span> <span class="nf">nblist_bonds</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate bonds from neighbor list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; Initial # of bonds &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>    
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span> <span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">indx_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_j</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">pid_j</span> <span class="o">&gt;</span> <span class="n">pid_i</span><span class="p">):</span>
                <span class="n">b_i</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">pid_j</span> <span class="p">)</span>            
                <span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">b_i</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; Final # of bonds &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; debug nblist_bonds&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nblist_angles</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate angles from neighbor list </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>    
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span> <span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">NNAB</span> <span class="o">=</span> <span class="n">N_f</span> <span class="o">-</span> <span class="n">N_o</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">indx_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="p">):</span>
                <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">indx_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">indx_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_k</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">pid_j</span> <span class="o">!=</span> <span class="n">pid_k</span> <span class="p">):</span>
                        <span class="n">a_i</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span> <span class="n">pid_k</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span> <span class="n">pid_j</span> <span class="p">)</span>            
                        <span class="n">strucC</span><span class="o">.</span><span class="n">angleC</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">a_i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nblist_dih</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate dihedrals from neighbor list </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">limdih</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="n">limitdih_n</span> <span class="o">=</span> <span class="mi">0</span>
 
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>    
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span> <span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">NNAB</span> <span class="o">=</span> <span class="n">N_f</span> <span class="o">-</span> <span class="n">N_o</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">indx_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_j</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">pid_j</span> <span class="o">&gt;</span> <span class="n">pid_i</span><span class="p">):</span>
		<span class="n">dih_ij_cnt</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">atom_k_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		<span class="n">atom_l_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">indx_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span> <span class="p">):</span>
                    <span class="n">pid_k</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">pid_k</span> <span class="o">!=</span> <span class="n">pid_j</span> <span class="p">):</span>
                        <span class="n">No_j</span> <span class="o">=</span>  <span class="n">cov_nbindx</span><span class="p">[</span> <span class="n">pid_j</span>  <span class="p">]</span>
                        <span class="n">Nf_j</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_j</span><span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">indx_l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">No_j</span><span class="p">,</span><span class="n">Nf_j</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">pid_l</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx_l</span><span class="p">]</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="n">pid_l</span> <span class="o">!=</span> <span class="n">pid_i</span> <span class="ow">and</span> <span class="n">pid_l</span> <span class="o">!=</span> <span class="n">pid_k</span> <span class="p">):</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">limdih</span> <span class="p">):</span>
				    <span class="k">if</span><span class="p">(</span> <span class="n">dih_ij_cnt</span> <span class="o">&lt;</span> <span class="n">limitdih_n</span> <span class="p">):</span>
					<span class="k">if</span><span class="p">(</span>  <span class="n">limitdih_n</span> <span class="o">==</span>  <span class="mi">2</span> <span class="ow">and</span> <span class="n">atom_k</span> <span class="o">!=</span> <span class="n">atom_k_i</span> <span class="ow">and</span> <span class="n">atom_l</span> <span class="o">!=</span> <span class="n">atom_l_i</span> <span class="p">):</span>

                                            <span class="n">d_i</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span> <span class="n">pid_k</span><span class="p">,</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">pid_j</span><span class="p">,</span> <span class="n">pid_l</span> <span class="p">)</span>            
                                            <span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">d_i</span><span class="p">)</span>
                                            <span class="n">dih_ij_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
					    <span class="n">atom_k_i</span> <span class="o">=</span> <span class="n">pid_k</span>
					    <span class="n">atom_l_i</span> <span class="o">=</span> <span class="n">pid_l</span>
					<span class="k">elif</span><span class="p">(</span> <span class="n">limitdih_n</span> <span class="o">!=</span>  <span class="mi">2</span> <span class="p">):</span>
                                            <span class="n">d_i</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span> <span class="n">pid_k</span><span class="p">,</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">pid_j</span><span class="p">,</span> <span class="n">pid_l</span> <span class="p">)</span>            
                                            <span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">d_i</span><span class="p">)</span>
					    <span class="n">dih_ij_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
					
				<span class="k">else</span><span class="p">:</span>
                                    <span class="n">d_i</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span> <span class="n">pid_k</span><span class="p">,</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">pid_j</span><span class="p">,</span> <span class="n">pid_l</span> <span class="p">)</span>            
                                    <span class="n">strucC</span><span class="o">.</span><span class="n">dihC</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">d_i</span><span class="p">)</span>

<div class="viewcode-block" id="build_covnablist"><a class="viewcode-back" href="../docstr_extras.html#topology.build_covnablist">[docs]</a><span class="k">def</span> <span class="nf">build_covnablist</span><span class="p">(</span><span class="n">strucC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build covalent neighbor list from elements and positions </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="n">p_time</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">n_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span> <span class="p">)</span>
    <span class="n">maxnnab</span> <span class="o">=</span> <span class="n">n_ptcl</span><span class="o">*</span><span class="mi">12</span>            <span class="c"># Assume max nieghbors as fcc </span>

    <span class="n">cov_buffer</span> <span class="o">=</span> <span class="mf">1.25</span>
    
    <span class="n">radi_cov</span> <span class="o">=</span>  <span class="p">[]</span>
    <span class="n">cov_nblist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxnnab</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span> <span class="p">)</span>
    <span class="n">cov_nbindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxnnab</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span> <span class="p">)</span>

    <span class="n">NNAB</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">p_time</span> <span class="p">):</span> <span class="n">t_i</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">):</span>
        <span class="n">error_line</span> <span class="o">=</span> <span class="s">&quot; empyt particle container passed to  build_covnablist &quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">error_line</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">el_symb</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">el_i</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
        <span class="n">r_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span><span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span><span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)]</span> <span class="p">)</span>
	<span class="n">rc_i</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cov_radii&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">cov_buffer</span>
	
	<span class="n">NNAB_i</span> <span class="o">=</span> <span class="n">NNAB</span> 
        <span class="k">for</span> <span class="n">pid_j</span><span class="p">,</span> <span class="n">ptclObj_j</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">pid_j</span> <span class="o">!=</span> <span class="n">pid_i</span> <span class="p">):</span>
                <span class="n">el_j</span> <span class="o">=</span>  <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                <span class="n">r_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span><span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span><span class="nb">float</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)]</span> <span class="p">)</span>
		<span class="n">r_ij</span> <span class="o">=</span> <span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span>
		<span class="n">mag_dr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_ij</span><span class="p">)</span>
                <span class="c">#r_ij = delta_r(r_i,r_j)</span>
                <span class="n">rc_j</span> <span class="o">=</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cov_radii&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">cov_buffer</span>
                <span class="n">r_cov</span> <span class="o">=</span> <span class="n">rc_i</span> <span class="o">+</span> <span class="n">rc_j</span>
    
                <span class="k">if</span><span class="p">(</span> <span class="n">mag_dr</span> <span class="o">&lt;=</span> <span class="n">r_cov</span> <span class="p">):</span>
                    <span class="n">NNAB</span> <span class="o">=</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">cov_nblist</span><span class="p">[</span><span class="n">NNAB</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pid_j</span>	
		    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
			<span class="k">print</span> <span class="s">&#39;    atom i/j &#39;</span><span class="p">,</span> <span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="n">el_i</span><span class="p">,</span><span class="n">el_j</span>
			<span class="k">print</span> <span class="s">&#39;       cov radi &#39;</span><span class="p">,</span><span class="n">rc_i</span> <span class="p">,</span> <span class="n">rc_j</span>
			<span class="k">print</span> <span class="s">&#39;       r_i &#39;</span><span class="p">,</span><span class="n">r_i</span>
			<span class="k">print</span> <span class="s">&#39;       r_j &#39;</span><span class="p">,</span><span class="n">r_j</span>
			<span class="k">print</span> <span class="s">&#39;       r_ij &#39;</span><span class="p">,</span><span class="n">r_ij</span> 
			<span class="k">print</span> <span class="s">&#39;       |r_ij| &#39;</span><span class="p">,</span><span class="n">mag_dr</span> 
			<span class="k">print</span> <span class="s">&#39;       r_cov &#39;</span><span class="p">,</span><span class="n">r_cov</span>
		    
	<span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
	    <span class="k">print</span> <span class="s">&quot;  atom &quot;</span><span class="p">,</span><span class="n">pid_i</span> <span class="p">,</span><span class="n">el_i</span><span class="p">,</span> <span class="s">&quot; has &quot;</span><span class="p">,</span><span class="n">NNAB</span> <span class="o">-</span> <span class="n">NNAB_i</span>  <span class="p">,</span><span class="s">&quot; bonded nieghbors &quot;</span>
	
    <span class="k">if</span><span class="p">(</span> <span class="n">p_time</span> <span class="p">):</span>
	<span class="n">t_f</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
	<span class="n">dt_sec</span>  <span class="o">=</span> <span class="n">t_f</span><span class="o">.</span><span class="n">second</span> <span class="o">-</span> <span class="n">t_i</span><span class="o">.</span><span class="n">second</span>
	<span class="n">dt_min</span>  <span class="o">=</span> <span class="n">t_f</span><span class="o">.</span><span class="n">minute</span> <span class="o">-</span> <span class="n">t_i</span><span class="o">.</span><span class="n">minute</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">dt_sec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">):</span> <span class="n">dt_sec</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">-</span> <span class="n">dt_sec</span>
	<span class="k">print</span> <span class="s">&quot;  build_nablist dt &quot;</span><span class="p">,</span><span class="n">dt_min</span><span class="p">,</span><span class="n">dt_sec</span>

    
    <span class="c"># Account for final atom position</span>
    <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span> <span class="n">pid_i</span>  <span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span> <span class="n">pid_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">N_f</span> <span class="o">-</span> <span class="n">N_o</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39; atom &#39;</span><span class="p">,</span> <span class="n">pid_i</span> <span class="p">,</span><span class="s">&#39; has &#39;</span><span class="p">,</span><span class="n">NNAB</span><span class="p">,</span><span class="s">&quot; neighbors &quot;</span><span class="p">,</span><span class="n">N_o</span>    
            <span class="c">#</span>
            <span class="c"># Find number of elements</span>
            <span class="c">#</span>
            <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
                <span class="k">print</span>  <span class="n">j</span>
                <span class="c">#    el_j = ELN[j]</span>
                <span class="c">#    ELCNT[j] = ELCNT[j] + 1</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;debug build_covnablist&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="build_nablist_bonds"><a class="viewcode-back" href="../docstr_extras.html#topology.build_nablist_bonds">[docs]</a><span class="k">def</span> <span class="nf">build_nablist_bonds</span><span class="p">(</span><span class="n">strucC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build nieghbor list using bonded information </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">numpy</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NNAB</span>  <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">maxnnab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c">#NBLIST = numpy.empty( maxnnab,  dtype=int )</span>
    <span class="c">#NBINDEX = numpy.empty( maxnnab,  dtype=int )</span>
    
    <span class="c"># python style nieghbor list</span>
    <span class="n">nblist_py</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#numpy.empty( maxnnab,  dtype=int )</span>
    
    <span class="n">NBLIST</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NBINDEX</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NBLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">atom_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)):</span>
	<span class="n">nblist_py</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">)</span>
        
    <span class="c"># Loop over bonds and record neighbors </span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>  <span class="nb">len</span><span class="p">(</span><span class="n">BONDS</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
	<span class="n">bnd_i</span> <span class="o">=</span> <span class="n">BONDS</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">bnd_j</span> <span class="o">=</span> <span class="n">BONDS</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
	
	<span class="n">nblist_py</span><span class="p">[</span><span class="n">bnd_i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">bnd_j</span> <span class="p">)</span>
	<span class="n">nblist_py</span><span class="p">[</span><span class="n">bnd_j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">bnd_i</span> <span class="p">)</span>
	
    <span class="c"># Translate 2D into 1D array</span>
    <span class="c">#   mostly to match perviously writen fortran code</span>
    
    <span class="k">for</span> <span class="n">nbs_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">nblist_py</span><span class="p">)):</span>
	<span class="n">nlist_i</span> <span class="o">=</span> <span class="n">nblist_py</span><span class="p">[</span><span class="n">nbs_i</span><span class="p">]</span>
	<span class="n">NBINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
	<span class="k">for</span> <span class="n">nb_i</span> <span class="ow">in</span>  <span class="n">nlist_i</span><span class="p">:</span>
	    <span class="n">NNAB</span> <span class="o">+=</span>  <span class="mi">1</span>
	    <span class="n">NBLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">nb_i</span> <span class="p">)</span>

    <span class="n">NBINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
    
	
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
       <span class="k">print</span> <span class="s">&#39; total nbs &#39;</span><span class="p">,</span><span class="n">NNAB</span><span class="p">,</span><span class="s">&#39; total bonds &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">BONDS</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">ELN</span><span class="p">)):</span>
	    <span class="n">N_o</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span> <span class="n">i</span>  <span class="p">]</span>
	    <span class="n">N_f</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	    <span class="n">NNAB</span> <span class="o">=</span> <span class="n">N_f</span> <span class="o">-</span> <span class="n">N_o</span> <span class="o">+</span> <span class="mi">1</span>
	    <span class="k">print</span> <span class="s">&#39; atom &#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">ELN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">NNAB</span><span class="p">,</span><span class="n">N_o</span><span class="p">,</span><span class="n">nblist_py</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	    
	<span class="c">#sys.exit(&#39;debug&#39;)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">NBLIST</span><span class="p">,</span><span class="n">NBINDEX</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="bonded_nblist"><a class="viewcode-back" href="../docstr_extras.html#topology.bonded_nblist">[docs]</a><span class="k">def</span> <span class="nf">bonded_nblist</span><span class="p">(</span><span class="n">strucC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create neighbor list of bonded particles</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">NNAB</span>  <span class="o">=</span> <span class="mi">0</span>

    <span class="n">maxnnab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; maxnnab&quot;</span><span class="p">,</span><span class="n">maxnnab</span>

    <span class="c">#NBLIST = numpy.empty( maxnnab,  dtype=int )</span>
    <span class="c">#NBINDEX = numpy.empty( maxnnab,  dtype=int )</span>

    <span class="c"># python style nieghbor list</span>
    <span class="n">nblist_py</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#numpy.empty( maxnnab,  dtype=int )</span>

    <span class="n">NBLIST</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NBINDEX</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NBLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>

    <span class="c"># First create an N diminsional list of index lists for each particle</span>

    <span class="k">for</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">prtclC</span> <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">nblist_py</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">)</span>
    <span class="n">nblist_py</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">)</span>

    <span class="c"># bassed on bonds add index of neighbros to particle index of nblist_py</span>
    <span class="k">for</span> <span class="n">b_i</span><span class="p">,</span><span class="n">bondObj</span> <span class="ow">in</span>  <span class="n">strucC</span><span class="o">.</span><span class="n">bondC</span><span class="p">:</span>
        <span class="n">bnd_i</span> <span class="o">=</span> <span class="n">bondObj</span><span class="o">.</span><span class="n">pgid1</span> 
        <span class="n">bnd_j</span> <span class="o">=</span> <span class="n">bondObj</span><span class="o">.</span><span class="n">pgid2</span> 

        <span class="n">nblist_py</span><span class="p">[</span><span class="n">bnd_i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">bnd_j</span> <span class="p">)</span>
        <span class="n">nblist_py</span><span class="p">[</span><span class="n">bnd_j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">bnd_i</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; adding bond bonded_nblist&quot;</span><span class="p">,</span><span class="n">bnd_i</span><span class="p">,</span><span class="n">bnd_j</span>

    <span class="c"># Translate 2D into 1D array</span>
    <span class="c">#   mostly to match perviously writen fortran code</span>
    <span class="k">for</span> <span class="n">nblis_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">nblist_py</span><span class="p">)):</span>
        <span class="c"># loop over  each particle p_i and get list of neighbors nlist_i</span>
        <span class="n">nlist_i</span> <span class="o">=</span> <span class="n">nblist_py</span><span class="p">[</span><span class="n">nblis_indx</span><span class="p">]</span>
        <span class="n">NBINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="c"># Loop over neighbor list of each particle nlist_i and get neighbor p_j</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="n">nblis_indx</span> <span class="c">#+ 1</span>
        <span class="k">for</span> <span class="n">p_j</span> <span class="ow">in</span>  <span class="n">nlist_i</span><span class="p">:</span>

            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;nblis_indx&quot;</span><span class="p">,</span><span class="n">nblis_indx</span>
                <span class="k">print</span> <span class="s">&quot; p_i &quot;</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="s">&quot; p_j &quot;</span><span class="p">,</span><span class="n">p_j</span>

            <span class="c">#if( p_j &gt; p_i):</span>
            <span class="c"># remove redundent neighbors </span>
            <span class="n">NNAB</span> <span class="o">+=</span>  <span class="mi">1</span>
            <span class="c"># add to neighbor list </span>
            <span class="n">NBLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">p_j</span> <span class="p">)</span>

    <span class="n">NBINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39; total nbs &#39;</span><span class="p">,</span><span class="n">NNAB</span>

        <span class="k">for</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">prtclC</span> <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="n">N_i_o</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span>
            <span class="n">N_i_f</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span><span class="n">p_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&quot; atom &quot;</span><span class="p">,</span><span class="n">p_i</span><span class="p">,</span><span class="n">prtclC</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot; has &quot;</span><span class="p">,</span><span class="n">N_i_f</span> <span class="o">-</span> <span class="n">N_i_o</span>

            <span class="k">for</span> <span class="n">indx_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_i_o</span><span class="p">,</span><span class="n">N_i_f</span><span class="p">):</span>
                <span class="n">atom_j</span> <span class="o">=</span> <span class="n">NBLIST</span><span class="p">[</span><span class="n">indx_j</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;      nb &quot;</span><span class="p">,</span><span class="n">atom_j</span><span class="p">,</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;bonded_nblist debug&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">NBLIST</span><span class="p">,</span><span class="n">NBINDEX</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="calc_nnab"><a class="viewcode-back" href="../docstr_extras.html#topology.calc_nnab">[docs]</a><span class="k">def</span> <span class="nf">calc_nnab</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">NBINDEX</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return number of nieghbors for a given atom </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c"># Find number of elements </span>
    <span class="c">#</span>
    <span class="n">N_o</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span> <span class="n">i</span>  <span class="p">]</span>
    <span class="n">N_f</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span>  <span class="n">i</span><span class="o">+</span><span class="mi">1</span>  <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> 
    <span class="n">NNAB</span> <span class="o">=</span> <span class="n">N_f</span> <span class="o">-</span> <span class="n">N_o</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">NNAB</span>

</div>
<div class="viewcode-block" id="calc_elcnt"><a class="viewcode-back" href="../docstr_extras.html#topology.calc_elcnt">[docs]</a><span class="k">def</span> <span class="nf">calc_elcnt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">NBLIST</span><span class="p">,</span><span class="n">NBINDEX</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="c">#</span>
    <span class="c"># Find number of elements </span>
    <span class="c">#</span>
    <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span><span class="nb">int</span> <span class="p">)</span>
    <span class="n">N_o</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span> <span class="n">i</span>  <span class="p">]</span>
    <span class="n">N_f</span> <span class="o">=</span> <span class="n">NBINDEX</span><span class="p">[</span>  <span class="n">i</span><span class="o">+</span><span class="mi">1</span>  <span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> 
    <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">NBLIST</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
        <span class="n">el_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="p">)</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">el_j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">):</span>
	    <span class="n">ELCNT</span><span class="p">[</span><span class="n">el_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ELCNT</span><span class="p">[</span><span class="n">el_j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ELCNT</span> 

</div>
<span class="k">def</span> <span class="nf">id_ring3</span><span class="p">(</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find atoms in conjugated rings </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">max_paths</span> <span class="o">=</span> <span class="mi">1000</span>
    
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">R_SET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BAD_PATH</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#a_i = pid_o -1 </span>
    <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># relabel based on neighbors</span>
    <span class="n">n_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; for a system of </span><span class="si">%d</span><span class="s"> partiles checking particle </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">,</span><span class="n">pid_o</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">pid_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
        <span class="n">R_SET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
        
    <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_o</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">r_term</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; initializing ring &#39;</span><span class="p">,</span><span class="n">pid_o</span><span class="p">,</span><span class="s">&quot; w NN &quot;</span><span class="p">,</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_o</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>

    <span class="n">last_i</span> <span class="o">=</span> <span class="n">pid_o</span>
    <span class="n">NNAB_last</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">r_term</span> <span class="p">):</span>
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">last_i</span><span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">last_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; checking neighbors &quot;</span><span class="p">,</span><span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span>

        <span class="k">for</span> <span class="n">n_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">n_indx</span><span class="p">]</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c"># If non of the neighboring atoms of atom j are conjugated</span>
            <span class="c">#    make the path as bad </span>
            <span class="k">if</span><span class="p">(</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">NNAB_last</span><span class="o">+</span><span class="mi">1</span> <span class="p">):</span>
                <span class="n">p_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; bad path found resetting at atom &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ring_a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">RING_ATOMS</span><span class="p">[</span><span class="n">ring_a</span><span class="p">]</span>
                    
                <span class="n">BAD_PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="c"># Reset lists and counts</span>
                <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pid_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">):</span>
                    <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_o</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">last_i</span> <span class="o">=</span> <span class="n">pid_o</span>
                
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;  resetting last_i to &#39;</span><span class="p">,</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                    
                <span class="k">for</span> <span class="n">bad_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">BAD_PATH</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">BAD_PATH</span><span class="p">[</span><span class="n">bad_i</span><span class="p">]</span>
                    <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;  bad path atoms &#39;</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                <span class="k">break</span>

            <span class="c"># If path traces back to original atom ring has been found </span>
            <span class="k">if</span><span class="p">(</span> <span class="n">atoms_in_ring</span>  <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">pid_o</span> <span class="p">):</span>
                <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; ring found with &#39;</span><span class="p">,</span><span class="n">atoms_in_ring</span> 
                <span class="k">break</span>

            <span class="n">number_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
            <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT_j</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">False</span> 
	    
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">number_j</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">NNAB_j</span><span class="p">,</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="c"># Test if atom j is conjugated </span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">16</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ELCNT_j</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">):</span> <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ring_type</span> <span class="p">):</span>
                <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="n">atoms_in_ring</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">RING_ATOMS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">last_i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">NNAB_last</span> <span class="o">=</span> <span class="n">NNAB_j</span> 
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;   atom &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">number_j</span><span class="p">,</span><span class="s">&#39; added &#39;</span>
                <span class="k">break</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">p_cnt</span> <span class="o">&gt;</span> <span class="n">max_paths</span> <span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;     max paths considered &#39;</span><span class="p">,</span><span class="n">max_paths</span>
            <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">RING_ATOMS</span>


<span class="k">def</span> <span class="nf">id_ring</span><span class="p">(</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find atoms in conjugated rings </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pid_o</span> <span class="o">==</span><span class="mi">7</span> <span class="p">):</span> <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="n">R_SET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BAD_PATH</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#a_i = pid_o -1 </span>
    <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># relabel based on neighbors</span>
    <span class="n">n_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; for a system of </span><span class="si">%d</span><span class="s"> partiles checking particle </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">,</span><span class="n">pid_o</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">pid_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
        <span class="n">R_SET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
        
    <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_o</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">r_term</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; initializing ring &#39;</span><span class="p">,</span><span class="n">pid_o</span><span class="p">,</span><span class="s">&quot; w NN &quot;</span><span class="p">,</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_o</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>

    <span class="n">last_i</span> <span class="o">=</span> <span class="n">pid_o</span>
    <span class="n">NNAB_last</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">r_term</span> <span class="p">):</span>
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">last_i</span><span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">last_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; checking neighbors &quot;</span><span class="p">,</span><span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span>

        <span class="k">for</span> <span class="n">n_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">n_indx</span><span class="p">]</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c"># If non of the neighboring atoms of atom j are conjugated</span>
            <span class="c">#    make the path as bad </span>
            <span class="k">if</span><span class="p">(</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">NNAB_last</span><span class="o">+</span><span class="mi">1</span> <span class="p">):</span>
                <span class="n">p_cnt</span> <span class="o">=</span> <span class="n">p_cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; bad path found resetting at atom &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ring_a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">RING_ATOMS</span><span class="p">[</span><span class="n">ring_a</span><span class="p">]</span>
                    
                <span class="n">BAD_PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="c"># Reset lists and counts</span>
                <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pid_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">):</span>
                    <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">R_SET</span><span class="p">[</span><span class="n">pid_o</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">last_i</span> <span class="o">=</span> <span class="n">pid_o</span>
                
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;  resetting last_i to &#39;</span><span class="p">,</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                    
                <span class="k">for</span> <span class="n">bad_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">BAD_PATH</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">BAD_PATH</span><span class="p">[</span><span class="n">bad_i</span><span class="p">]</span>
                    <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;  bad path atoms &#39;</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
                <span class="k">break</span>

            <span class="c"># If path traces back to original atom ring has been found </span>
            <span class="k">if</span><span class="p">(</span> <span class="n">atoms_in_ring</span>  <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">pid_o</span> <span class="p">):</span>
                <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; ring found with &#39;</span><span class="p">,</span><span class="n">atoms_in_ring</span> 
                <span class="k">break</span>

            <span class="n">number_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
            <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT_j</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">False</span> 
	    
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">number_j</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">NNAB_j</span><span class="p">,</span>
		<span class="k">print</span> <span class="s">&#39;           with &#39;</span><span class="p">,</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="c"># Test if atom j is conjugated </span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">16</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ELCNT_j</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">):</span> <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ring_type</span> <span class="p">):</span>
                <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="n">atoms_in_ring</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">RING_ATOMS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">R_SET</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">last_i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">NNAB_last</span> <span class="o">=</span> <span class="n">NNAB_j</span> 
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;   atom &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">number_j</span><span class="p">,</span><span class="s">&#39; added &#39;</span>
                <span class="k">break</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">p_cnt</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;     max paths considered &#39;</span><span class="p">,</span><span class="mi">100</span>
            <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">RING_ATOMS</span>

<div class="viewcode-block" id="ring_type"><a class="viewcode-back" href="../docstr_extras.html#topology.ring_type">[docs]</a><span class="k">def</span> <span class="nf">ring_type</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Criteria for a conjugated particle </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="n">number_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>
    <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
    <span class="n">ELCNT_j</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;            atomic # </span><span class="si">%d</span><span class="s">  NN  </span><span class="si">%d</span><span class="s"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">number_j</span><span class="p">,</span> <span class="n">NNAB_j</span><span class="p">)</span>

    <span class="c"># Test if atom j is conjugated </span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">16</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">ELCNT_j</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">):</span> <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">number_j</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">NNAB_j</span> <span class="o">&gt;=</span> <span class="mi">2</span>  <span class="p">):</span>                      <span class="n">ring_type</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">ring_type</span>

</div>
<span class="k">def</span> <span class="nf">id_ring2</span><span class="p">(</span><span class="n">pid_o</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find atoms in conjugated rings </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_ring_particles</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">max_paths</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#if( pid_o ==7 ): debug = True</span>
    
    <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BAD_PATH</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#a_i = pid_o -1 </span>
    <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># relabel based on neighbors</span>
    <span class="n">n_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; for a system of </span><span class="si">%d</span><span class="s"> partiles checking particle </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">,</span><span class="n">pid_o</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">pid_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
        <span class="n">BAD_PATH</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        
    
    <span class="n">r_term</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">path_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; initializing ring with particle &#39;</span><span class="p">,</span><span class="n">pid_o</span> 

    <span class="n">pid_i</span> <span class="o">=</span> <span class="n">pid_o</span>
    <span class="n">last_j</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">NNAB_last</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">r_term</span> <span class="p">):</span>
        <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
        <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; checking pid_i </span><span class="si">%d</span><span class="s"> w </span><span class="si">%d</span><span class="s"> neighbors &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">))</span>
        <span class="c">#           j</span>
        <span class="c">#        /</span>
        <span class="c">#  pid_i - j</span>
        <span class="c">#        \</span>
        <span class="c">#           j</span>
        <span class="c">#</span>
        <span class="n">path_found</span> <span class="o">=</span> <span class="bp">False</span> 
        <span class="k">for</span> <span class="n">n_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">n_indx</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; checking NN </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

            <span class="c"># If path traces back to original atom ring has been found </span>
            <span class="k">if</span><span class="p">(</span> <span class="n">atoms_in_ring</span>  <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">pid_o</span> <span class="p">):</span>
                <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">path_found</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; ring found with &#39;</span><span class="p">,</span><span class="n">atoms_in_ring</span> 
                <span class="k">break</span>
            <span class="n">j_good</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span> <span class="k">print</span> <span class="s">&quot; check if j is part of a bad path &quot;</span><span class="p">,</span><span class="n">BAD_PATH</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span> 
            <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">BAD_PATH</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; j marked as a bad path &quot;</span>
                <span class="n">j_good</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Prevent looping back</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">RING_ATOMS</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="n">pid_o</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; j already in path &quot;</span>
                <span class="n">j_good</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span><span class="p">(</span>  <span class="n">j_good</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ring_type</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">ptclObj_o</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">atoms_in_ring</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">RING_ATOMS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">last_j</span> <span class="o">=</span> <span class="n">pid_i</span>  
                    <span class="n">pid_i</span> <span class="o">=</span> <span class="n">j</span>           <span class="c"># set j to </span>
                    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot;   atom </span><span class="si">%d</span><span class="s"> added atom # </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">])</span>
                        <span class="k">print</span> <span class="s">&quot;      last_j &quot;</span><span class="p">,</span><span class="n">last_j</span>
                        <span class="k">print</span> <span class="s">&quot;      pid_i &quot;</span><span class="p">,</span><span class="n">pid_i</span>

                    <span class="n">path_found</span> <span class="o">=</span> <span class="bp">True</span> 
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; skipping previously found to prevent looping back &quot;</span><span class="p">,</span><span class="n">last_j</span>

        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">path_found</span> <span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; path not found pid_i </span><span class="si">%d</span><span class="s"> last_j </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">last_j</span><span class="p">)</span>
                
                
            <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">==</span> <span class="n">pid_o</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39; path has been reduced back to original atom </span><span class="si">%d</span><span class="s"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="n">BAD_PATH</span><span class="p">[</span><span class="n">last_j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">pid_i</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot;setting bad path </span><span class="si">%d</span><span class="s"> for last_j </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">last_j</span><span class="p">)</span>
            
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; pre pop RING_ATOMS &quot;</span><span class="p">,</span><span class="n">RING_ATOMS</span>
                <span class="n">RING_ATOMS</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot; post pop RING_ATOMS &quot;</span><span class="p">,</span><span class="n">RING_ATOMS</span>

                <span class="n">pid_i</span> <span class="o">=</span> <span class="n">last_j</span>
                <span class="n">last_j</span> <span class="o">=</span> <span class="n">RING_ATOMS</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pid_i</span> <span class="o">=</span> <span class="n">pid_o</span>
                
            
            <span class="k">if</span><span class="p">(</span> <span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot; Bad path found no conjugated atoms &quot;</span> <span class="c"># attached to  %d stepping back to %d &quot;%(BAD_PATH[-1],pid_i)</span>
                <span class="k">print</span> <span class="s">&quot;RING_ATOMS &quot;</span><span class="p">,</span><span class="n">RING_ATOMS</span>
                <span class="k">print</span> <span class="s">&quot;BAD_PATH &quot;</span><span class="p">,</span><span class="n">BAD_PATH</span>
            
        
        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_ring_particles</span> <span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;   maximum possible particles in ring </span><span class="si">%d</span><span class="s"> exceeded &#39;</span><span class="o">%</span><span class="n">max_ring_particles</span>
                <span class="k">print</span> <span class="s">&quot;   pid_i </span><span class="si">%d</span><span class="s"> last_j </span><span class="si">%d</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">last_j</span><span class="p">)</span>
            <span class="c"># Set last atom as a bad path</span>
            <span class="c">#BAD_PATH[pid_i]</span>
            
            <span class="c"># Reset lists and counts</span>
            <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atoms_in_ring</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">last_j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pid_i</span> <span class="o">=</span> <span class="n">pid_o</span>

            <span class="n">path_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">path_cnt</span> <span class="o">&gt;</span> <span class="n">max_paths</span> <span class="p">):</span>
                <span class="n">r_term</span> <span class="o">=</span> <span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">RING_ATOMS</span>


<div class="viewcode-block" id="find_rings"><a class="viewcode-back" href="../docstr_extras.html#topology.find_rings">[docs]</a><span class="k">def</span> <span class="nf">find_rings</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find conjugate rings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">RINGLIST</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RINGINDEX</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RING_NUMB</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">IN_RING</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">n_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>
    <span class="n">one</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">ring_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># relabel based on neighbors</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">IN_RING</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
        <span class="n">RINGLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">RING_NUMB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">RINGINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>

    <span class="n">RING_NUMB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
    <span class="n">RINGLIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
    <span class="n">RINGINDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>

        
    <span class="c"># relabel based on neighbors</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># If particle i is conjugated </span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ring_type</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">RING_ATOMS</span> <span class="o">=</span> <span class="n">id_ring3</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
            <span class="k">print</span> <span class="n">pid_i</span><span class="p">,</span><span class="n">RING_ATOMS</span>
            
        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
            <span class="c"># If member of ring alread part of another ring add new ring to existing ring</span>
            <span class="n">r_numb</span> <span class="o">=</span> <span class="mi">0</span> 
            <span class="k">for</span> <span class="n">ring_a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">RING_ATOMS</span><span class="p">[</span><span class="n">ring_a</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">):</span>
                    <span class="n">r_numb</span> <span class="o">=</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">r_numb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
                <span class="n">ring_cnt</span> <span class="o">=</span> <span class="n">ring_cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">r_numb</span> <span class="o">=</span> <span class="n">ring_cnt</span> 
                <span class="c">#print &#39; new ring &#39;,ring_cnt</span>
                 
            <span class="k">for</span> <span class="n">ring_a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RING_ATOMS</span><span class="p">)):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">RING_ATOMS</span><span class="p">[</span><span class="n">ring_a</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span> 
                    <span class="n">a_cnt</span> <span class="o">=</span> <span class="n">a_cnt</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_numb</span>

    <span class="n">a_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r_numb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ring_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">r_numb</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_cnt</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ptcl</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">r_numb</span> <span class="p">):</span>
                <span class="n">a_cnt</span> <span class="o">=</span> <span class="n">a_cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">RINGLIST</span><span class="p">[</span><span class="n">a_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                
    <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">ring_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_cnt</span> <span class="o">+</span> <span class="mi">1</span>


    <span class="c"># Set attached H to have same ring #</span>
    <span class="n">attach_H</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">attach_H</span> <span class="p">):</span>

        <span class="k">for</span> <span class="n">r_numb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ring_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">r_numb</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">r_numb</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39; Ring &#39;</span><span class="p">,</span> <span class="n">r_numb</span>
            <span class="k">for</span> <span class="n">r_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">RINGLIST</span><span class="p">[</span><span class="n">r_indx</span><span class="p">]</span>
                <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">n_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">n_indx</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
                        <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_numb</span>
		

    <span class="c"># update particles </span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&#39; atom  &#39;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
	    		
	    

        <span class="c">#debug = True</span>
    <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">ring_cnt</span> <span class="p">,</span> <span class="s">&quot; rings found &quot;</span>
        <span class="k">for</span> <span class="n">r_numb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ring_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">r_numb</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">RINGINDEX</span><span class="p">[</span><span class="n">r_numb</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39; Ring &#39;</span><span class="p">,</span> <span class="n">r_numb</span>
            <span class="k">for</span> <span class="n">r_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">RINGLIST</span><span class="p">[</span><span class="n">r_indx</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&#39; type &#39;</span><span class="p">,</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">],</span><span class="s">&#39; or &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">RING_NUMB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c">#sys.exit(&#39;find_rings&#39;)</span>
                
        <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>    
            <span class="k">print</span> <span class="s">&#39; atom  &#39;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
	    
	<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;top.find_rings&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span> <span class="n">strucC</span><span class="p">,</span> <span class="n">RINGLIST</span><span class="p">,</span> <span class="n">RINGINDEX</span>  <span class="p">)</span>
</div>
<div class="viewcode-block" id="get_nrings"><a class="viewcode-back" href="../docstr_extras.html#topology.get_nrings">[docs]</a><span class="k">def</span> <span class="nf">get_nrings</span><span class="p">(</span><span class="n">strucC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the number of rings in a structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrings</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nrings</span> <span class="p">):</span>
            <span class="n">nrings</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nrings</span>
</div>
<div class="viewcode-block" id="set_chargegroups"><a class="viewcode-back" href="../docstr_extras.html#topology.set_chargegroups">[docs]</a><span class="k">def</span> <span class="nf">set_chargegroups</span><span class="p">(</span><span class="n">ff_charges</span><span class="p">,</span><span class="n">strucC</span> <span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set charge groups </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span> 
    
    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
	<span class="k">print</span> <span class="s">&quot;   Setting charge groups &quot;</span>
    
    
    <span class="c"># initialize </span>
    <span class="n">n_groups</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c">#CG_SET = []</span>
    <span class="c">#for pid_i, ptclObj_i  in strucC.ptclC:</span>
    <span class="c">#        CG_SET.append(True) </span>

    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="c"># set rings as charge groups</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="c"># If unset set chrge group </span>
        <span class="c">#    if( CG_SET[i] ):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">):</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>
                <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot; setting qgroup  ring &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">n_groups</span> <span class="p">):</span>
                    <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
                
    <span class="c">#if( debug): sys.exit(&#39;ring charge groups&#39;)</span>
            
    <span class="c"># set methyls and alkyls </span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="c"># If unset set chrge group</span>
        <span class="c">#    if( CG_SET[i] ):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">):</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">ELCNT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>  <span class="c"># CH_n ( Methyls / alkyl ) </span>
                <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c">#CG_SET[i] = 0</span>
                <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
                        <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
                        <span class="c">#CG_SET[j] = 0</span>
			
            <span class="k">if</span><span class="p">(</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>  <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="p">):</span>  <span class="c"># </span>
                <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c">#CG_SET[i] = 0</span>
                <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">):</span>
                        <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>

                    <span class="c">#if ( ELN[j] == 8 ):</span>
                    <span class="c">#    CHARN[j] = n_groups</span>
                    <span class="c">#    CG_SET[j] = 0</span>

            <span class="k">if</span><span class="p">(</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ON&#39;</span> <span class="p">):</span>  <span class="c"># nitroxide</span>
                <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c">#CG_SET[i] = 0</span>
                <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
                        <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>

                    <span class="c">#j = cov_nblist[j_indx]</span>
                    <span class="c">#if ( CG_SET[j]  ):</span>
		    <span class="c">#CHARN[j] = n_groups</span>
                    <span class="c">#	CG_SET[j] = 0</span>

    <span class="c"># check unset heavy atom groups</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="c"># If unset set chrge group</span>
        <span class="c">#    if( CG_SET[i] ):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">):</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">):</span>  <span class="c">#</span>
		<span class="n">q_g</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">):</span>
                        <span class="n">q_g</span> <span class="o">=</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span>
                        <span class="k">break</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">q_g</span>  <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
			
		    <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
		    <span class="c">#CG_SET[i] = 0</span>
		    <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
		<span class="k">else</span><span class="p">:</span>
		    <span class="c">#CG_SET[i] = 0</span>
		    <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_g</span>
		    
		<span class="c">#print &quot; unset carbon set to &quot;,ptclObj_i.tagsDict[&quot;qgroup&quot;]</span>
			

            <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CA&#39;</span> <span class="p">):</span>  <span class="c"># conjugate</span>
                <span class="n">n_groups</span> <span class="o">=</span> <span class="n">n_groups</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c"># CG_SET[i] = 0</span>
                <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
 
                    

    <span class="c"># set light atom groups </span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="c"># If unset set chrge group</span>
        <span class="c">#    if( CG_SET[i] ):</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">):</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">):</span>
                <span class="n">j_set</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">):</span>
                        <span class="n">n_groups</span> <span class="o">=</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span>
                        <span class="n">j_set</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">j_set</span> <span class="p">):</span>
                    <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>
                    <span class="c">#CG_SET[i] = 0</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">print</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span> <span class="p">,</span><span class="s">&#39; connected to unset atom &#39;</span>
                    <span class="k">print</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s">&quot; - &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span> 
                    <span class="k">print</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s">&quot; - &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> 
                    <span class="c">#for i in range(NA):</span>
                    <span class="c">#    print i,ASYMB[i],ATYPE[i]</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;charge group error&#39;</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LP&#39;</span> <span class="p">):</span>
                <span class="n">j_set</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">):</span>
                        <span class="n">n_groups</span> <span class="o">=</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span>
                        <span class="n">j_set</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">j_set</span> <span class="p">):</span>
                    <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_groups</span>

                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39; lone pair connected to unset atom &#39;</span>
                    <span class="k">print</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s">&quot; - &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">]</span> 
                    <span class="k">print</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s">&quot; - &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span> 
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;charge group error&#39;</span><span class="p">)</span>
                    

		
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="c"># If unset set chrge group</span>
             <span class="k">print</span> <span class="n">i</span><span class="p">,</span><span class="n">ASYMB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">CG_SET</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">],</span>  <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	     
	     
    <span class="c"># Check for unset atoms </span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="k">print</span> <span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;symbol&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">],</span><span class="n">NNAB</span><span class="p">,</span><span class="n">ELCNT</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">ELCNT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39; not set &#39;</span>
	    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;charge group error&#39;</span><span class="p">)</span>
            <span class="c">#else :</span>
            <span class="c"># print ASYMB[i],ATYPE[i],NNAB,ELCNT[6],ELCNT[1],GTYPE[i],&#39; set &#39;</span>

    <span class="k">return</span> <span class="n">strucC</span>
</div>
<div class="viewcode-block" id="qgroup_maxvol"><a class="viewcode-back" href="../docstr_extras.html#topology.qgroup_maxvol">[docs]</a><span class="k">def</span> <span class="nf">qgroup_maxvol</span><span class="p">(</span><span class="n">strucC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the maximum volume of the charge groups</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">qgrp_max</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">qgrp_max</span> <span class="p">):</span>
            <span class="n">qgrp_max</span> <span class="o">=</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span>


    <span class="k">print</span> <span class="s">&quot;    Charge groups &quot;</span><span class="p">,</span><span class="n">qgrp_max</span>
    <span class="n">a_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a_min</span> <span class="o">=</span> <span class="mf">1e16</span>

    <span class="n">dr_x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e16</span>
    <span class="n">dV_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e16</span>

    <span class="k">for</span> <span class="n">q_g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="n">qgrp_max</span><span class="o">+</span><span class="mi">1</span> <span class="p">):</span>
        <span class="n">atom_cnt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">r_x_min</span> <span class="o">=</span> <span class="mf">1e16</span> 
        <span class="n">r_y_min</span> <span class="o">=</span> <span class="mf">1e16</span>
        <span class="n">r_z_min</span> <span class="o">=</span> <span class="mf">1e16</span>
        <span class="n">r_x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e16</span> 
        <span class="n">r_y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e16</span>
        <span class="n">r_z_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e16</span>

        <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;qgroup&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">q_g</span> <span class="p">):</span>
                <span class="n">atom_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c">#print R[i]</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r_x_min</span>  <span class="p">):</span> <span class="n">r_x_min</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r_y_min</span>  <span class="p">):</span> <span class="n">r_y_min</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r_z_min</span>  <span class="p">):</span> <span class="n">r_z_min</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_x_max</span>  <span class="p">):</span> <span class="n">r_x_max</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_y_max</span>  <span class="p">):</span> <span class="n">r_y_max</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_z_max</span>  <span class="p">):</span> <span class="n">r_z_max</span> <span class="o">=</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 


        <span class="k">if</span><span class="p">(</span> <span class="n">atom_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span> <span class="k">print</span> <span class="s">&quot;      Group &quot;</span><span class="p">,</span><span class="n">q_g</span><span class="p">,</span><span class="s">&quot; has 0 atoms &quot;</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">atom_cnt</span> <span class="o">&gt;</span> <span class="n">a_max</span> <span class="p">):</span> <span class="n">a_max</span> <span class="o">=</span> <span class="n">atom_cnt</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">atom_cnt</span> <span class="o">&lt;</span> <span class="n">a_min</span> <span class="p">):</span> <span class="n">a_min</span> <span class="o">=</span> <span class="n">atom_cnt</span>

        <span class="n">dr_x</span> <span class="o">=</span> <span class="n">r_x_max</span> <span class="o">-</span> <span class="n">r_x_min</span>
        <span class="n">dr_y</span> <span class="o">=</span> <span class="n">r_y_max</span> <span class="o">-</span> <span class="n">r_y_min</span>
        <span class="n">dr_z</span> <span class="o">=</span> <span class="n">r_z_max</span> <span class="o">-</span> <span class="n">r_z_min</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">dr_x</span> <span class="o">&gt;</span> <span class="n">dr_x_max</span> <span class="p">):</span> <span class="n">dr_x_max</span> <span class="o">=</span> <span class="n">dr_x</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">dr_y</span> <span class="o">&gt;</span> <span class="n">dr_x_max</span> <span class="p">):</span> <span class="n">dr_x_max</span> <span class="o">=</span> <span class="n">dr_y</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">dr_z</span> <span class="o">&gt;</span> <span class="n">dr_x_max</span> <span class="p">):</span> <span class="n">dr_x_max</span> <span class="o">=</span> <span class="n">dr_z</span> 

        <span class="c"># Cubic PBC&#39;s</span>
        <span class="c">#dr_x_pbc,dr_y_pbc,dr_z_pbc = prop.pbc_r_c(dr_x,dr_y,dr_z,LV)	    </span>

        <span class="n">dV</span> <span class="o">=</span> <span class="n">dr_x</span><span class="o">*</span><span class="n">dr_y</span><span class="o">*</span><span class="n">dr_z</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">dV</span> <span class="o">&gt;</span> <span class="n">dV_max</span> <span class="p">):</span> <span class="n">dV_max</span> <span class="o">=</span> <span class="n">dV</span>

        <span class="c">#print &quot;      Group &quot;,q_g,&quot; has &quot;,atom_cnt,&quot; atoms in volume &quot;,dV,&quot; A^3 &quot;</span>

    <span class="k">print</span> <span class="s">&quot;    Max atoms in group &quot;</span><span class="p">,</span><span class="n">a_max</span>
    <span class="k">print</span> <span class="s">&quot;    Min atoms in group &quot;</span><span class="p">,</span><span class="n">a_min</span>
    <span class="k">print</span> <span class="s">&quot;    Max dr and dV &quot;</span><span class="p">,</span><span class="n">dr_x_max</span><span class="p">,</span> <span class="n">dV_max</span>

</div>
<div class="viewcode-block" id="find_conections"><a class="viewcode-back" href="../docstr_extras.html#topology.find_conections">[docs]</a><span class="k">def</span> <span class="nf">find_conections</span><span class="p">(</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">,</span> <span class="n">ring_nblist</span><span class="p">,</span> <span class="n">ring_nbindex</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find inter conjugated ring  atoms </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">numpy</span> 
           
    <span class="n">RING_CONNECT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">)</span>
    <span class="n">ADDED</span> <span class="o">=</span>  <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NA</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span> <span class="p">)</span>    
    <span class="c"># Find Ring linkers</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>        
        <span class="k">if</span> <span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">NNAB</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">NNAB</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">):</span>  <span class="c"># if sp2</span>
                <span class="n">ELCNT</span> <span class="o">=</span> <span class="n">calc_elcnt</span><span class="p">(</span><span class="n">pid_i</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
                <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
                <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                    <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">ADDED</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
                        <span class="n">NNAB_j</span> <span class="o">=</span> <span class="n">calc_nnab</span><span class="p">(</span><span class="n">pid_j</span><span class="p">,</span><span class="n">cov_nbindx</span><span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">NNAB_j</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">):</span>  <span class="c"># if sp2</span>
                            <span class="k">if</span><span class="p">(</span>   <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="o">!=</span>  <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;ring&quot;</span><span class="p">]</span> <span class="p">):</span> <span class="c"># ring linker</span>
                                <span class="n">ADDED</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">ADDED</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                                    <span class="k">print</span> <span class="n">i</span><span class="p">,</span><span class="s">&#39; and &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39; link &#39;</span><span class="p">,</span><span class="n">ELN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ELN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">RING_NUMB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="n">RING_CONNECT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">pid_i</span><span class="p">,</span><span class="n">pid_j</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">RING_CONNECT</span>

</div>
<span class="k">def</span> <span class="nf">set_cply_tags</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">):</span>
    <span class="c">#</span>
    <span class="c">#  Set tags for new cply file </span>
    <span class="c">#     Use ctype tag and bonding enviroment</span>
    <span class="c">#</span>
    
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot;    setting cply tags &quot;</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>

        <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">debug</span> <span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;CHECKING CTYPE &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">],</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span>
	
	<span class="c"># Set terminal attached carbons </span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;T&quot;</span> <span class="ow">and</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">):</span>
	    <span class="c">#</span>
	    <span class="n">term_con_cnt</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Terminal connections count</span>
	    <span class="c">#</span>
	    <span class="c"># Find terminal hydrogen</span>
	    <span class="c">#		    </span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	    <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;X&quot;</span> <span class="ow">and</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
		    <span class="c"># Check to see if it has been bonded to another unit </span>
		    <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;residue&quot;</span><span class="p">]</span> <span class="o">==</span>  <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;residue&quot;</span><span class="p">]</span> <span class="p">):</span>
			<span class="n">term_con_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;termcap_H(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid_j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)_on_C(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_i</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
		      
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;term_C(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid_i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Number of terminal atoms attached to atom &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="s">&quot; greater than 1 &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in terminal connections &quot;</span><span class="p">)</span>
	    
	<span class="c"># Set functional attached carbons </span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;F&quot;</span> <span class="ow">and</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">):</span>
	    <span class="c">#</span>
	    <span class="n">term_con_cnt</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Terminal connections count</span>
	    <span class="c"># </span>
	    <span class="c"># Find function hydrogen</span>
	    <span class="c">#</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	    <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span> <span class="ow">and</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
		    <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;residue&quot;</span><span class="p">]</span> <span class="o">==</span>  <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;residue&quot;</span><span class="p">]</span> <span class="p">):</span>
			<span class="n">term_con_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;funccap_H(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid_j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)_on_C(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_i</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;cplytag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;func_C(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid_i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
		
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Number of functional atoms attached to atom &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="s">&quot; not equal to 1 &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in functional connections &quot;</span><span class="p">)</span>
		
    <span class="k">return</span> <span class="n">strucC</span>	

<span class="k">def</span> <span class="nf">zero_unitq</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span><span class="n">strucC</span><span class="p">,</span><span class="n">cov_nblist</span><span class="p">,</span> <span class="n">cov_nbindx</span><span class="p">,</span><span class="n">zero_term</span><span class="p">,</span><span class="n">zero_func</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">sys</span> 
    
    <span class="c">#</span>
    <span class="c"># Sum exsessive charges into carbon atoms </span>
    <span class="c">#</span>
    <span class="k">for</span> <span class="n">pid_i</span><span class="p">,</span> <span class="n">ptclObj_i</span>  <span class="ow">in</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">:</span>                
	<span class="c"># Find each terminal hydrogen</span>
	<span class="k">if</span><span class="p">(</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span>  <span class="o">==</span> <span class="s">&quot;X&quot;</span>  <span class="ow">and</span> <span class="n">zero_term</span>  <span class="p">):</span>
	    <span class="n">term</span> <span class="o">=</span> <span class="n">pid_i</span> 
	    <span class="c"># Check to be sure hydrogen</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span>  <span class="o">!=</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Non hydrogen used as terminal group atom &quot;</span><span class="p">,</span><span class="n">pid_i</span>  
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Code unable to process multi atom (nonhyrdogen) terminal group &quot;</span><span class="p">)</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Terminal atom found &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
	    <span class="c">#</span>
	    <span class="c"># Loop over nieghbors to find attached atom</span>
	    <span class="c">#</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	    <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>                
                <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
                
		<span class="n">term_con_cnt</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Terminal connections count</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;T&quot;</span> <span class="p">):</span>
		    <span class="n">term_con_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
		    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
			<span class="k">print</span> <span class="s">&quot; Terminal connection found &quot;</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
		    <span class="n">term_con</span> <span class="o">=</span> <span class="n">pid_j</span>
	    <span class="c"># Check to be sure multiple atoms not found</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; No terminal connections found &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in terminal connections &quot;</span><span class="p">)</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Multiple terminal connections found &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in terminal connections &quot;</span><span class="p">)</span>
		
	    <span class="c"># Sum charges into base monomer unit</span>
            <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term_con</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term_con</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>  <span class="o">+</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> 
	    <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>   <span class="o">=</span> <span class="mf">0.0</span>
	    
	<span class="c"># Find each functional hydrogen</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span>  <span class="ow">and</span> <span class="n">zero_func</span> <span class="p">):</span>
	    <span class="n">term</span> <span class="o">=</span> <span class="n">pid_i</span> 
	    <span class="c"># Check to be sure hydrogen</span>
	    <span class="k">if</span><span class="p">(</span>  <span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Non hydrogen used as functional group &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Code unable to process multi atom (nonhyrdogen) functional group &quot;</span><span class="p">)</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Functional atom found &quot;</span><span class="p">,</span><span class="n">pid_i</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="n">ptclObj_i</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
	    <span class="c">#</span>
	    <span class="c"># Loop over nieghbors to find attached atom</span>
	    <span class="c">#</span>
            <span class="n">N_o</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="p">]</span>
            <span class="n">N_f</span> <span class="o">=</span> <span class="n">cov_nbindx</span><span class="p">[</span><span class="n">pid_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	    <span class="k">for</span> <span class="n">j_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">N_o</span><span class="p">,</span><span class="n">N_f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pid_j</span> <span class="o">=</span> <span class="n">cov_nblist</span><span class="p">[</span><span class="n">j_indx</span><span class="p">]</span>
                <span class="n">ptclObj_j</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">pid_j</span><span class="p">]</span>
		<span class="n">term_con_cnt</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Terminal connections count</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;linkid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;F&quot;</span> <span class="p">):</span>
		    <span class="n">term_con_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
		    <span class="k">if</span><span class="p">(</span> <span class="n">verbose</span> <span class="p">):</span>
			<span class="k">print</span> <span class="s">&quot; functional connection found &quot;</span><span class="p">,</span><span class="n">pid_j</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="n">ptclObj_j</span><span class="o">.</span><span class="n">tagsDict</span><span class="p">[</span><span class="s">&quot;fftype&quot;</span><span class="p">]</span>
		    <span class="n">term_con</span> <span class="o">=</span> <span class="n">pid_j</span>
	    <span class="c"># Check to be sure multiple atoms not found</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span>  <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; No functional connections found &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in functional connections &quot;</span><span class="p">)</span>
	    <span class="c"># Check to be sure multiple atoms not found</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">term_con_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot; Multiple functional connections found &quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot; Error in functional connections &quot;</span><span class="p">)</span>
	    <span class="c"># Sum charges into base monomer unit</span>
            <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term_con</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term_con</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>  <span class="o">+</span> <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> 
	    <span class="n">strucC</span><span class="o">.</span><span class="n">ptclC</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>   <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">strucC</span>



<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    def create_top(self,ff_charges): # Move out of class (or derived class)</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="sd">        Find topology information for force-field input files </span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="sd">        # Version 1 will be dependent on Atomicpy</span>
<span class="sd">        import elements , lammps ,gromacs , atom_types, top </span>

<span class="sd">        # Create list to pass to Atomicpy</span>
<span class="sd">        ASYMB = []</span>
<span class="sd">        R = []</span>
<span class="sd">        AMASS = []</span>
<span class="sd">        CHARGES = []</span>
<span class="sd">        MOLNUMB = []</span>
<span class="sd">        RESID = []</span>
<span class="sd">        RESN = []</span>
<span class="sd">        GTYPE = []</span>
<span class="sd">        </span>
<span class="sd">        for pid, ptclObj  in self.ptclC:</span>
<span class="sd">            ASYMB.append( ptclObj.type  )</span>
<span class="sd">            R.append( np.array( [ float( ptclObj.position[0] ),float( ptclObj.position[1] ),float( ptclObj.position[2] )]  )  )</span>
<span class="sd">            AMASS.append( float( ptclObj.mass)  )</span>
<span class="sd">            CHARGES.append( float( ptclObj.charge ) )</span>
<span class="sd">            MOLNUMB.append( int( ptclObj.tagsDict[&quot;chain&quot;] ) )</span>
<span class="sd">            RESID.append( int( ptclObj.tagsDict[&quot;residue&quot;] ) )</span>
<span class="sd">            RESN.append(  ptclObj.tagsDict[&quot;resname&quot;]  )</span>
<span class="sd">            GTYPE.append( ptclObj.tagsDict[&quot;gtype&quot;] )</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        # Direct copy of top.print_ff_files</span>
<span class="sd">            </span>

<span class="sd">        # Read in ff file</span>
<span class="sd">        #itp_file = &#39;ff.itp&#39;</span>
<span class="sd">        ##print &quot;   Read in parameters from &quot;,itp_file</span>
<span class="sd">        #FF_ATOMTYPES , FF_BONDTYPES , FF_ANGLETYPES ,  FF_DIHTYPES = gromacs.read_itp(itp_file)</span>
<span class="sd">                 </span>
<span class="sd">        # New options that need to be passed </span>
<span class="sd">        limdih =  0</span>
<span class="sd">        limitdih_n = 1</span>
<span class="sd">        verbose = True </span>

<span class="sd">        # Find atomic number based on atomic symbol </span>
<span class="sd">        ELN = elements.asymb_eln(ASYMB)</span>
<span class="sd">        AMASS = elements.eln_amass(ELN)</span>

<span class="sd">        #   Initialize  topology values</span>
<span class="sd">        #GTYPE = top.initialize_gtype( ELN )  # need to do this in frag read in </span>
<span class="sd">        CHARN = top.initialize_charn( ELN )        </span>

<span class="sd">        NA = len(ELN)</span>
<span class="sd">        </span>
<span class="sd">        find_bonds = False </span>
<span class="sd">        if( find_bonds ):</span>

<span class="sd">            #   Build covalent nieghbor list for bonded information </span>
<span class="sd">            NBLIST, NBINDEX = top.build_covnablist(ELN,R)</span>
<span class="sd">            BONDS = top.nblist_bonds(NA,NBLIST, NBINDEX)</span>

<span class="sd">            print_bonds = True</span>
<span class="sd">            if( print_bonds ):</span>
<span class="sd">                for b_indx in range(len(BONDS)):</span>
<span class="sd">                    print &quot; bond &quot;,BONDS[b_indx][0]+1,BONDS[b_indx][1]+1</span>

<span class="sd">                sys.exit(&quot; print bonds from proximity &quot;)</span>
<span class="sd">        else:</span>
<span class="sd">            BONDS = []</span>
<span class="sd">            for b_i,bondObj in  self.bondC:</span>
<span class="sd">                pt_i = bondObj.pgid1</span>
<span class="sd">                pt_j = bondObj.pgid2</span>
<span class="sd">                BONDS.append( [pt_i-1,pt_j-1])</span>
<span class="sd">                print &quot;create_top  bond &quot;,pt_i,pt_j</span>

<span class="sd">            NBLIST,NBINDEX = groups.build_nablist_bonds(ELN,BONDS)</span>
<span class="sd">            #sys.exit(&quot; passing bonds checking &quot;)</span>
<span class="sd">            </span>

<span class="sd">        print_bonds = True</span>
<span class="sd">        if( print_bonds ):</span>
<span class="sd">            for b_indx in range(len(BONDS)):</span>
<span class="sd">                print &quot; bond &quot;,BONDS[b_indx][0]+1,BONDS[b_indx][1]+1</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        ANGLES = top.nblist_angles(NA,NBLIST, NBINDEX)</span>
<span class="sd">        #DIH = top.nblist_dih(NA,NBLIST, NBINDEX,options.limdih,options.limitdih_n)</span>
<span class="sd">        DIH = top.nblist_dih(NA,NBLIST, NBINDEX,limdih,limitdih_n)</span>
<span class="sd">        IMPS = top.nblist_imp(NA,NBLIST, NBINDEX,ELN)</span>

<span class="sd">        #</span>
<span class="sd">        # Set charge groups</span>
<span class="sd">        #</span>
<span class="sd">        CG_SET = []</span>
<span class="sd">        one = 1</span>
<span class="sd">        for i in range( len(ELN) ):</span>
<span class="sd">            CG_SET.append(one)</span>
<span class="sd">        #</span>

<span class="sd">        if( verbose ):</span>
<span class="sd">            print &quot;      Finding atom types  &quot;</span>
<span class="sd">            if( ff_charges ):</span>
<span class="sd">                print &quot;      Using ff charges &quot;</span>

<span class="sd">        d_mass = 0</span>
<span class="sd">        d_charge = 0</span>

<span class="sd">        find_rings = False </span>
<span class="sd">        NA = len(ELN)</span>
<span class="sd">        if( find_rings ):</span>
<span class="sd">            RINGLIST, RINGINDEX , RING_NUMB = top.find_rings(ELN,NBLIST,NBINDEX)</span>
<span class="sd">        else:</span>
<span class="sd">            zero = 0.0</span>

<span class="sd">            RINGLIST = []</span>
<span class="sd">            RINGINDEX = []</span>
<span class="sd">            RING_NUMB = []</span>

<span class="sd">            # relabel based on neighbors</span>
<span class="sd">            for i in range(NA):</span>
<span class="sd">                RINGLIST.append(zero)</span>
<span class="sd">                RING_NUMB.append(zero)</span>
<span class="sd">                RINGINDEX.append(zero)</span>

<span class="sd">            RINGLIST.append(zero)</span>
<span class="sd">            RINGINDEX.append(zero)</span>

<span class="sd">        # Asign oplsaa atom types</span>
<span class="sd">        ATYPE, CHARGES = atom_types.oplsaa( ff_charges,ELN,CHARGES,NBLIST,NBINDEX,RINGLIST, RINGINDEX , RING_NUMB)</span>

<span class="sd">        #ATYPE , CHARGES = atom_types.biaryl_types( ff_charges, ATYPE, ELN,NBLIST,NBINDEX,RINGLIST, RINGINDEX , RING_NUMB, CHARGES )</span>
<span class="sd">        ATYPE ,RESID, CHARGES = atom_types.set_pmmatypes(ff_charges, ELN, ATYPE,GTYPE,RESID,CHARGES,NBLIST,NBINDEX,RINGLIST, RINGINDEX , RING_NUMB )</span>

<span class="sd">        </span>
<span class="sd">        ATYPE,RESID,CHARGES,CG_SET,CHARN = atom_types.set_ptmatypes( ff_charges, ELN,ASYMB, ATYPE,GTYPE,RESID,CHARGES,AMASS,NBLIST,NBINDEX,RINGLIST, RINGINDEX , RING_NUMB,CG_SET,CHARN )</span>

<span class="sd">        debug = False </span>
<span class="sd">        if(debug):</span>
<span class="sd">            # relabel based on neighbors</span>
<span class="sd">            NA = len(ELN)</span>
<span class="sd">            for i in range(NA):</span>
<span class="sd">                print  i+1,ATYPE[i] ,RESID[i], CHARGES[i]</span>
<span class="sd">            sys.exit(&quot; atom chagre check 1 &quot;)</span>

<span class="sd">        #Refind inter ring types</span>
<span class="sd">        ATYPE , CHARGES  = atom_types.interring_types(ff_charges, ATYPE, ELN,NBLIST,NBINDEX,RINGLIST, RINGINDEX , RING_NUMB, CHARGES )</span>

<span class="sd">        # Update structure information</span>
<span class="sd">        pt_cnt = 0</span>
<span class="sd">        for pid, ptclObj  in self.ptclC:</span>
<span class="sd">             ptclObj.tagsDict[&quot;fftype&quot;] = ATYPE[pt_cnt]</span>
<span class="sd">             ptclObj.mass = AMASS[pt_cnt]</span>
<span class="sd">             ptclObj.charge = CHARGES[pt_cnt]</span>
<span class="sd">             ptclObj.tagsDict[&quot;ring&quot;] = RING_NUMB[pt_cnt]</span>
<span class="sd">             pt_cnt += 1 </span>

<span class="sd">        # Add bonds to system</span>
<span class="sd">        #for i in range( len(BONDS) ):</span>
<span class="sd">        #    #</span>
<span class="sd">        #    a_i = BONDS[i][0] </span>
<span class="sd">        #    a_j = BONDS[i][1]</span>
<span class="sd">        #    b_i = Bond( a_i+1, a_j+1 )</span>
<span class="sd">        #    self.bondC.put(b_i)</span>

<span class="sd">            #  Sudo code</span>
<span class="sd">            #   Read in parameter file</span>
<span class="sd">            #      gromacs itp file</span>
<span class="sd">            #      tinker parameter file</span>
<span class="sd">            #      lammps parameters in data file</span>
<span class="sd">            #   Find bonds</span>
<span class="sd">            #      from gaussian output optimization</span>
<span class="sd">            #      distance cut-off</span>
<span class="sd">            #         system_i = system_i.bonds()</span>
<span class="sd">            #   Find Rings</span>
<span class="sd">            #   Guess atom types</span>
<span class="sd">            #      amber</span>
<span class="sd">            #      oplsaa</span>
<span class="sd">            #         oligomer = oligomer.guess_oplsaatypes()</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def find_types(struc_o,param_all):</span>
<span class="sd">    Find all the force-field parameters associated with a structure </span>

<span class="sd">    ptclC_o =  struc_o.ptclC</span>
<span class="sd">    bondC_o  = struc_o.bondC</span>
<span class="sd">    angleC_o  = struc_o.angleC</span>
<span class="sd">    dihC_o  = struc_o.dihC</span>
<span class="sd">    </span>
<span class="sd">    #param_i = ParameterContainer()</span>
<span class="sd">    #</span>
<span class="sd">    # Create new parameter container to hold each unique type</span>
<span class="sd">    #   which exsists in the structure container struc_i</span>
<span class="sd">    #   this is necessary for parameter outputs to no have</span>
<span class="sd">    #   redundent values </span>
<span class="sd">    #</span>
<span class="sd">    paramC_o = ParameterContainer()</span>
<span class="sd">    </span>
<span class="sd">    ljtypC_p =  paramC_p.ljtypC</span>
<span class="sd">    btypC_p =  paramC_p.btypC</span>
<span class="sd">    atypC_p =  paramC_p.atypC</span>
<span class="sd">    dtypC_p =  paramC_p.dtypC</span>
<span class="sd">    </span>
<span class="sd">    #</span>
<span class="sd">    # Count atom types</span>
<span class="sd">    #</span>
<span class="sd">    debug = 1</span>
<span class="sd">    for pid_o, ptclObj_o  in ptclC_o:    </span>
<span class="sd">        new_type = 1</span>
<span class="sd">        lpid_p = 0</span>
<span class="sd">        for lpid_p, ptclObj_p  in ptclC_p:    </span>
<span class="sd">            if( ptclObj_o.tagsDict[&quot;fftype&quot;] == ptclObj_p.tagsDict[&quot;fftype&quot;] ):</span>
<span class="sd">                new_type = 0</span>
<span class="sd">                ptclObj_o.type = str( lpid_p )</span>
<span class="sd">                if(debug): print &#39; maches previous &#39;,ptclObj_p.tagsDict[&quot;fftype&quot;]</span>
<span class="sd">        if( new_type ):</span>
<span class="sd">            ptclC_p.put(ptclObj_o)</span>
<span class="sd">            ptclObj_o.type = str( lpid_p + 1 )</span>
<span class="sd">            if(debug): print &#39; new type found &#39;,ptclObj_o.tagsDict[&quot;fftype&quot;]</span>

<span class="sd">    debug = 0</span>
<span class="sd">    if(debug):</span>
<span class="sd">        print &quot; types found %d &quot;%(len(ptclC_p))</span>
<span class="sd">        for lpid_p, ptclObj_p  in ptclC_p:</span>
<span class="sd">            print ptclObj_p.tagsDict[&quot;fftype&quot;],ptclObj_p.type</span>
<span class="sd">        print &quot;  All particles should have new type labeled as interger stored as a string &quot;</span>
<span class="sd">        for pid_o, ptclObj_o  in ptclC_o:</span>
<span class="sd">            print ptclObj_o.tagsDict[&quot;fftype&quot;],ptclObj_o.type</span>
<span class="sd">        sys.exit(&#39;find_types&#39;)</span>



<span class="sd">    #</span>
<span class="sd">    # Count bonds types</span>
<span class="sd">    #</span>
<span class="sd">    debug = 1</span>
<span class="sd">    if( debug ):</span>
<span class="sd">        print &quot; len( bondC_o)&quot;,len( bondC_o)</span>
<span class="sd">    if( len( bondC_o) &gt; 0 ):</span>
<span class="sd">        for b_o,bondObj_o in bondC_o:</span>
<span class="sd">            new_type = 1</span>
<span class="sd">            b_p = 0</span>
<span class="sd">            AT_i =  ptclC_o[ bondObj_o.pgid1 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">            AT_j =  ptclC_o[ bondObj_o.pgid2 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">            for b_p,bondObj_p in bondC_p:</span>
<span class="sd">                p_i = ptclC_o[ bondObj_p.pgid1 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">                p_j = ptclC_o[ bondObj_p.pgid2 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">                if ( AT_i == p_i  and  AT_j == p_j ):</span>
<span class="sd">                    new_type = 0</span>
<span class="sd">                    bondObj_o.type = b_p</span>
<span class="sd">                    break</span>
<span class="sd">                if ( AT_j == p_i  and  AT_i == p_j ):</span>
<span class="sd">                    new_type = 0</span>
<span class="sd">                    bondObj_o.type = b_p</span>
<span class="sd">                    break</span>
<span class="sd">                </span>
<span class="sd">            # If new </span>
<span class="sd">            if( new_type ):</span>
<span class="sd">                bondC_p.put(bondObj_o)</span>
<span class="sd">                bondObj_o.type = str( b_p + 1 )</span>
<span class="sd">                #if(debug): print &#39; New bond type %s - %s  type -&gt; %d &#39;%(AT_i ,  AT_j, b_p + 1 )</span>
<span class="sd">                </span>
<span class="sd">            if(debug):</span>
<span class="sd">                print &#39;Bond type %s - %s  type -&gt; %s &#39;%(AT_i ,  AT_j,bondObj_o.type  )</span>

<span class="sd">    if(debug): sys.exit(&#39;BTYPE_IND&#39;)</span>
<span class="sd">    #</span>
<span class="sd">    # Count angles types</span>
<span class="sd">    #</span>
<span class="sd">    if( len(angleC_o) &gt; 0):</span>
<span class="sd">        # </span>
<span class="sd">        for a_o,angleObj_o in angleC_o:</span>
<span class="sd">            new_type = 1</span>
<span class="sd">            AT_k =  ptclC_o[ angleObj_o.pgid1 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">            AT_i =  ptclC_o[ angleObj_o.pgid2 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">            AT_j =  ptclC_o[ angleObj_o.pgid3 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">            a_p = 0</span>
<span class="sd">            for a_p,angleObj_p in angleC_p:</span>
<span class="sd">                p_k = ptclC_o[ angleObj_p.pgid1 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">                p_i = ptclC_o[ angleObj_p.pgid2 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">                p_j = ptclC_o[ angleObj_p.pgid3 ].tagsDict[&quot;fftype&quot;]</span>
<span class="sd">                if ( AT_k == p_k and  AT_i == p_i and  AT_j == p_j ):</span>
<span class="sd">                    new_type = 0</span>
<span class="sd">                    angleC_p.put(angleObj_o)</span>
<span class="sd">                    break</span>
<span class="sd">    </span>
<span class="sd">                if ( AT_j == p_k and  AT_i == p_i and  AT_k == p_j ):</span>
<span class="sd">                    new_type = 0</span>
<span class="sd">                    angleC_p.put(angleObj_o)</span>
<span class="sd">                    break</span>
<span class="sd">    </span>
<span class="sd">            # If new </span>
<span class="sd">            if( new_type ):</span>
<span class="sd">                angleC_p.put(angleObj_o)</span>
<span class="sd">                bondObj_o.type = str( a_p + 1 )</span>
<span class="sd">                if(debug):</span>
<span class="sd">                    print  &#39; new angle type &#39;,AT_i ,  AT_j , AT_k</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Dr. Scott W. Sides, Dr. Travis Kemper.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b2.
    </div>
  </body>
</html>